
    <!DOCTYPE html>
    <html lang="zh-CN"
            
          
    >
    <head>
    <meta charset="utf-8">
    

    

    
    <title>
        OS:p2-code |
        
        Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CUbuntu%20Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
    
<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/v4-font-face.min.css">

    
<link rel="stylesheet" href="/css/loader.css">

    <meta name="description" content="MathJax.Hub.Config({ tex2jax: {inlineMath: [[&#39;$&#39;, &#39;$&#39;]]}, messageStyle: &quot;none&quot; });   1. System.c 内容:  有用的函数(例如，StrEqual, Min，…) 打印函数(例如printIntVar，…) 涉及堆分配和释放的函数 混杂。语言支持例程，包括错误处理 涉及THROW和CATCH处理">
<meta property="og:type" content="article">
<meta property="og:title" content="OS:p2-code">
<meta property="og:url" content="https://abinzzz.github.io/2023/10/22/OS-p2-code/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="MathJax.Hub.Config({ tex2jax: {inlineMath: [[&#39;$&#39;, &#39;$&#39;]]}, messageStyle: &quot;none&quot; });   1. System.c 内容:  有用的函数(例如，StrEqual, Min，…) 打印函数(例如printIntVar，…) 涉及堆分配和释放的函数 混杂。语言支持例程，包括错误处理 涉及THROW和CATCH处理">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-10-21T16:52:58.000Z">
<meta property="article:modified_time" content="2023-11-11T05:01:56.412Z">
<meta property="article:author" content="野中晴">
<meta property="article:tag" content="专业知识">
<meta property="article:tag" content="p2">
<meta property="article:tag" content="code">
<meta name="twitter:card" content="summary">
    
        <link rel="alternate" href="/atom.xml" title="Blog" type="application/atom+xml">
    
    
        <link rel="shortcut icon" href="/images/favicon.ico">
    
    
        
<link rel="stylesheet" href="https://unpkg.com/typeface-source-code-pro@1.1.13/index.css">

    
    
<link rel="stylesheet" href="/css/style.css">

    
        
<link rel="stylesheet" href="https://unpkg.com/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

    
    
        
<link rel="stylesheet" href="https://unpkg.com/katex@0.16.7/dist/katex.min.css">

    
    
    
    
<script src="https://unpkg.com/pace-js@1.2.4/pace.min.js"></script>

    
        
<link rel="stylesheet" href="https://unpkg.com/wowjs@1.1.3/css/libs/animate.css">

        
<script src="https://unpkg.com/wowjs@1.1.3/dist/wow.min.js"></script>

        <script>
          new WOW({
            offset: 0,
            mobile: true,
            live: false
          }).init();
        </script>
    
<meta name="generator" content="Hexo 5.4.2"></head>

    <body>
    
<div id='loader'>
  <div class="loading-left-bg"></div>
  <div class="loading-right-bg"></div>
  <div class="spinner-box">
    <div class="loading-taichi">
      <svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="http://www.w3.org/2000/svg" shape-rendering="geometricPrecision">
      <path d="M303.5 432A80 80 0 0 1 291.5 592A80 80 0 0 1 303.5 432z" fill="#ff6e6b" />
      <path d="M512 65A447 447 0 0 1 512 959L512 929A417 417 0 0 0 512 95A417 417 0 0 0 512 929L512 959A447 447 0 0 1 512 65z" fill="#fd0d00" />
      <path d="M512 95A417 417 0 0 1 929 512A208.5 208.5 0 0 1 720.5 720.5L720.5 592A80 80 0 0 0 720.5 432A80 80 0 0 0 720.5 592L720.5 720.5A208.5 208.5 0 0 1 512 512A208.5 208.5 0 0 0 303.5 303.5A208.5 208.5 0 0 0 95 512A417 417 0 0 1 512 95" fill="#fd0d00" />
    </svg>
    </div>
    <div class="loading-word">Loading...</div>
  </div>
</div>
</div>

<script>
  const endLoading = function() {
    document.body.style.overflow = 'auto';
    document.getElementById('loader').classList.add("loading");
  }
  window.addEventListener('load', endLoading);
  document.getElementById('loader').addEventListener('click', endLoading);
</script>


    <div id="container">
        <div id="wrap">
            <header id="header">
    
        <img data-src="https://singyesterday.com/cmn/images/gallery/l/pic_200325_22.jpg" data-sizes="auto" alt="OS:p2-code" class="lazyload">
    
    <div id="header-outer" class="outer">
        <div id="header-title" class="inner">
            <div id="logo-wrap">
                
                    
                    
                        <a href="/" id="logo"><h1>OS:p2-code</h1></a>
                    
                
            </div>
            
                
                
            
        </div>
        <div id="header-inner">
            <nav id="main-nav">
                <a id="main-nav-toggle" class="nav-icon"></a>
                
                    <span class="main-nav-link-wrap">
                        <span class="main-nav-icon"></span>
                        <a class="main-nav-link" href="/">首页</a>
                    </span>
                
                    <span class="main-nav-link-wrap">
                        <span class="main-nav-icon"></span>
                        <a class="main-nav-link" href="/archives">归档</a>
                    </span>
                
                    <span class="main-nav-link-wrap">
                        <span class="main-nav-icon"></span>
                        <a class="main-nav-link" href="/about">关于</a>
                    </span>
                
                    <span class="main-nav-link-wrap">
                        <span class="main-nav-icon"></span>
                        <a class="main-nav-link" href="/friend">友链</a>
                    </span>
                
            </nav>
            <nav id="sub-nav">
                
                    <a id="nav-rss-link" class="nav-icon" href="/atom.xml"
                       title="RSS 订阅"></a>
                
                
            </nav>
            <div id="search-form-wrap">
                <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://abinzzz.github.io"></form>
            </div>
        </div>
    </div>
</header>

            <div id="content" class="outer">
                <section id="main"><article id="post-OS-p2-code" class="h-entry article article-type-post"
         itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
    <div class="article-inner">
        <div class="article-meta">
            <div class="article-date wow slideInLeft">
    <a href="/2023/10/22/OS-p2-code/" class="article-date-link">
        <time datetime="2023-10-21T16:52:58.000Z"
              itemprop="datePublished">2023-10-22</time>
    </a>
</div>

            
    <div class="article-category wow slideInLeft">
        <a class="article-category-link" href="/categories/%E4%B8%93%E4%B8%9A%E7%9F%A5%E8%AF%86/">专业知识</a><a class="article-category-link" href="/categories/%E4%B8%93%E4%B8%9A%E7%9F%A5%E8%AF%86/OS/">OS</a>
    </div>


        </div>
        <div class="hr-line"></div>
        

        <div class="e-content article-entry" itemprop="articleBody">
            
                <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: {inlineMath: [['$', '$']]}, messageStyle: "none" });
</script>
<h2 id="1-systemc"><a class="markdownIt-Anchor" href="#1-systemc"></a> 1. <code>System.c</code></h2>
<p><strong>内容</strong>:</p>
<ul>
<li>有用的函数(例如，StrEqual, Min，…)</li>
<li>打印函数(例如printIntVar，…)</li>
<li>涉及堆分配和释放的函数</li>
<li>混杂。语言支持例程，包括错误处理</li>
<li>涉及THROW和CATCH处理的函数</li>
</ul>
<br>
<p><strong>函数目录</strong>：</p>
<ul>
<li>MemoryEqual</li>
</ul>
<h2 id="11-memoryequal-比较两块内存区域是否相等"><a class="markdownIt-Anchor" href="#11-memoryequal-比较两块内存区域是否相等"></a> 1.1 MemoryEqual: 比较两块内存区域是否相等</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">MemoryEqual</span> <span class="params">(s1, s2: ptr to <span class="type">char</span>, len: <span class="type">int</span>)</span> returns <span class="type">bool</span></span><br><span class="line">  --</span><br><span class="line">  -- Return TRUE <span class="keyword">if</span> the blocks of memory contain the same bytes.</span><br><span class="line">  --</span><br><span class="line">    var i: <span class="type">int</span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">0</span> to len<span class="number">-1</span></span><br><span class="line">      <span class="keyword">if</span> *s1 != *s2</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      endIf</span><br><span class="line">      s1 = s1 + <span class="number">1</span></span><br><span class="line">      s2 = s2 + <span class="number">1</span></span><br><span class="line">    endFor</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>函数接收两个char指针s1、s2,以及要比较的长度len</li>
<li>通过for循环逐字节比较s1和s2指向的内存块</li>
<li>如果发现对应字节不相等,则返回false</li>
<li>如果完全相等,循环结束后返回true</li>
</ul>
<br>
<h2 id="12-strequal-比较两个字符串是否相等"><a class="markdownIt-Anchor" href="#12-strequal-比较两个字符串是否相等"></a> 1.2 StrEqual: 比较两个字符串是否相等</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">StrEqual</span> <span class="params">(s1, s2: String)</span> returns <span class="type">bool</span></span><br><span class="line">    --</span><br><span class="line">    -- Return TRUE <span class="keyword">if</span> the strings have the same size and contain</span><br><span class="line">    -- the same characters</span><br><span class="line">    --</span><br><span class="line">    var i: <span class="type">int</span></span><br><span class="line">    <span class="keyword">if</span> s1 arraySize != s2 arraySize</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    endIf</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">0</span> to s1 arraySize<span class="number">-1</span></span><br><span class="line">      <span class="keyword">if</span> s1[i] != s2[i]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      endIf</span><br><span class="line">    endFor</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>首先比较两个字符串的长度,如果长度不同,直接返回false</li>
<li>然后通过for循环逐个字符比较两个字符串</li>
<li>一旦发现字符不同,立即返回false</li>
<li>如果遍历完全相同,返回true</li>
</ul>
<br>
<h2 id="13-strcopy将字符串s2的内容拷贝到s1"><a class="markdownIt-Anchor" href="#13-strcopy将字符串s2的内容拷贝到s1"></a> 1.3 StrCopy:将字符串s2的内容拷贝到s1</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">StrCopy</span> <span class="params">(s1, s2: String)</span></span><br><span class="line">    --</span><br><span class="line">    -- This function copies the characters of s2 into s1.  The sizes of</span><br><span class="line">    -- s1 and s2 will not change.</span><br><span class="line">    --</span><br><span class="line">    -- If the two strings are different sizes this function will copy</span><br><span class="line">    -- however many characters it can, i.e., it will copy</span><br><span class="line">    -- <span class="title function_">min</span><span class="params">(s1.size, s2.size)</span> characters.</span><br><span class="line">    --</span><br><span class="line">    -- Note that <span class="keyword">if</span> s1 is longer than s2, you may not get exactly what</span><br><span class="line">    -- you expect, since some of the  characters originally in s1</span><br><span class="line">    -- will remain there.</span><br><span class="line">    --</span><br><span class="line">    var i, sz: <span class="type">int</span></span><br><span class="line">    sz = Min (s1 arraySize, s2 arraySize)</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">0</span> to sz<span class="number">-1</span></span><br><span class="line">      s1[i] = s2[i]</span><br><span class="line">    endFor</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>计算两个字符串的最小长度sz</li>
<li>通过for循环将s2复制到s1,最多拷贝sz个字符</li>
</ul>
<br>
<h2 id="14-strcmp-比较两个字符串的大小关系"><a class="markdownIt-Anchor" href="#14-strcmp-比较两个字符串的大小关系"></a> 1.4 StrCmp: 比较两个字符串的大小关系</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">StrCmp</span> <span class="params">(s1, s2: String)</span> returns <span class="type">int</span>    -- <span class="keyword">return</span> -1 <span class="keyword">if</span> &lt;, 0 <span class="keyword">if</span> =, +<span class="number">1</span> <span class="keyword">if</span> &gt;</span><br><span class="line">    --</span><br><span class="line">    -- Return an integer code telling whether s1 is lexicographically</span><br><span class="line">    -- less-than, equal, or greater-than s2.</span><br><span class="line">    --     Return</span><br><span class="line">    --       <span class="number">-1</span> when s1 &lt; s2</span><br><span class="line">    --        <span class="number">0</span> when s1 = s2</span><br><span class="line">    --       +<span class="number">1</span> when s1 &gt; s2</span><br><span class="line">    --</span><br><span class="line">    var sz: <span class="type">int</span> = Min (s1 arraySize, s2 arraySize)</span><br><span class="line">        i: <span class="type">int</span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">0</span> to sz<span class="number">-1</span></span><br><span class="line">      <span class="keyword">if</span> s1[i] &lt; s2[i]</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">      elseIf s1[i] &gt; s2[i]</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">      endIf</span><br><span class="line">    endFor</span><br><span class="line">    <span class="keyword">if</span> s1 arraySize &lt; s2 arraySize</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">    elseIf s1 arraySize &gt; s2 arraySize</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    endIf</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>计算两个字符串的最小长度sz</li>
<li>逐个字符比较s1和s2的大小关系
<ul>
<li>如果s1字符小于s2字符,返回-1</li>
<li>如果s1字符大于s2字符,返回1</li>
</ul>
</li>
<li>如果在最小长度内的字符都相等,再比较长度
<ul>
<li>如果s1长度小于s2,返回-1</li>
<li>如果s1长度大于s2,返回1</li>
<li>如果长度也相等,返回0</li>
</ul>
</li>
</ul>
<br>
<h2 id="15-min最小值"><a class="markdownIt-Anchor" href="#15-min最小值"></a> 1.5 Min:最小值</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">Min</span> <span class="params">(i, j: <span class="type">int</span>)</span> returns <span class="type">int</span></span><br><span class="line">    --</span><br><span class="line">    -- Return the smaller of the two arguments.</span><br><span class="line">    --</span><br><span class="line">    <span class="keyword">if</span> i&lt;j</span><br><span class="line">      <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> j</span><br><span class="line">    endIf</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>对两个整数i和j进行比较</li>
<li>如果i小于j,返回i</li>
<li>否则返回j</li>
</ul>
<br>
<h2 id="16-max-最大值"><a class="markdownIt-Anchor" href="#16-max-最大值"></a> 1.6 Max: 最大值</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">Max</span> <span class="params">(i, j: <span class="type">int</span>)</span> returns <span class="type">int</span></span><br><span class="line">    --</span><br><span class="line">    -- Return the larger of the two arguments.</span><br><span class="line">    --</span><br><span class="line">    <span class="keyword">if</span> i&gt;j</span><br><span class="line">      <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> j</span><br><span class="line">    endIf</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>对两个整数i和j进行比较</li>
<li>如果i大于j,返回i</li>
<li>否则返回j</li>
</ul>
<br>
<h2 id="17-printintvar打印整数变量的辅助函数"><a class="markdownIt-Anchor" href="#17-printintvar打印整数变量的辅助函数"></a> 1.7 printIntVar:打印整数变量的辅助函数</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">printIntVar</span> <span class="params">(s: String, i: <span class="type">int</span>)</span></span><br><span class="line">  --</span><br><span class="line">  -- Helper function to making printing the value of a variable easier.</span><br><span class="line">  -- For example:</span><br><span class="line">  --       <span class="title function_">printIntVar</span> <span class="params">(<span class="string">&quot;myVar&quot;</span>, myVar)</span></span><br><span class="line">  -- prints out:</span><br><span class="line">  --       myVar = <span class="number">123</span></span><br><span class="line">  --</span><br><span class="line">    print (s)</span><br><span class="line">    print (<span class="string">&quot; = &quot;</span>)</span><br><span class="line">    printInt (i)</span><br><span class="line">    nl () </span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>打印变量名s</li>
<li>打印等号&quot;=&quot;</li>
<li>打印变量的值i</li>
<li>打印换行符</li>
</ul>
<br>
<h2 id="18-printhexvar打印整数变量十六进制值的辅助函数"><a class="markdownIt-Anchor" href="#18-printhexvar打印整数变量十六进制值的辅助函数"></a> 1.8 printHexVar:打印整数变量十六进制值的辅助函数</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">printHexVar</span> <span class="params">(s: String, i: <span class="type">int</span>)</span></span><br><span class="line">  --</span><br><span class="line">  -- Helper function to making printing the value of a variable easier.</span><br><span class="line">  -- For example:</span><br><span class="line">  --       <span class="title function_">printHexVar</span> <span class="params">(<span class="string">&quot;myVar&quot;</span>, myVar)</span></span><br><span class="line">  -- prints out:</span><br><span class="line">  --       myVar = <span class="number">0x0000007B</span></span><br><span class="line">  --</span><br><span class="line">    print (s)</span><br><span class="line">    print (<span class="string">&quot; = &quot;</span>)</span><br><span class="line">    printHex (i)</span><br><span class="line">    nl () </span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>打印变量名称</li>
<li>打印等号</li>
<li>使用printHex打印变量的十六进制值</li>
<li>打印换行符</li>
</ul>
<br>
<h2 id="19-printboolvar打印布尔类型变量的辅助函数"><a class="markdownIt-Anchor" href="#19-printboolvar打印布尔类型变量的辅助函数"></a> 1.9 printBoolVar:打印布尔类型变量的辅助函数</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">printBoolVar</span> <span class="params">(s: String, b: <span class="type">bool</span>)</span></span><br><span class="line">  --</span><br><span class="line">  -- Helper function to making printing the value of a variable easier.</span><br><span class="line">  -- For example:</span><br><span class="line">  --       <span class="title function_">printBoolVar</span> <span class="params">(<span class="string">&quot;myVar&quot;</span>, myVar)</span></span><br><span class="line">  -- prints out:</span><br><span class="line">  --       myVar = TRUE</span><br><span class="line">  --</span><br><span class="line">    print (s)</span><br><span class="line">    print (<span class="string">&quot; = &quot;</span>)</span><br><span class="line">    printBool (b)</span><br><span class="line">    nl () </span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>打印变量名称</li>
<li>打印等号</li>
<li>使用printBool打印布尔值</li>
<li>打印换行符</li>
</ul>
<Br>
<h2 id="110-printcharvar-打印字符变量的辅助函数"><a class="markdownIt-Anchor" href="#110-printcharvar-打印字符变量的辅助函数"></a> 1.10 printCharVar: 打印字符变量的辅助函数</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">printCharVar</span> <span class="params">(s: String, c: <span class="type">char</span>)</span></span><br><span class="line">  --</span><br><span class="line">  -- Helper function to making printing the value of a variable easier.</span><br><span class="line">  -- For example:</span><br><span class="line">  --       <span class="title function_">printCharVar</span> <span class="params">(<span class="string">&quot;myVar&quot;</span>, myVar)</span></span><br><span class="line">  -- prints out:</span><br><span class="line">  --       myVar = <span class="string">&#x27;q&#x27;</span></span><br><span class="line">  --</span><br><span class="line">    print (s)</span><br><span class="line">    print (<span class="string">&quot; = &#x27;&quot;</span>)</span><br><span class="line">    printChar (c)</span><br><span class="line">    print (<span class="string">&quot;&#x27;\n&quot;</span>)</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>打印变量名</li>
<li>打印等号 和单引号</li>
<li>通过printChar打印字符值</li>
<li>打印闭合的单引号 和 换行符</li>
</ul>
<br>
<h2 id="111-printptr-打印指针变量的辅助函数"><a class="markdownIt-Anchor" href="#111-printptr-打印指针变量的辅助函数"></a> 1.11 printPtr: 打印指针变量的辅助函数</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">printPtr</span> <span class="params">(s: String, p: ptr to <span class="type">void</span>)</span></span><br><span class="line">  --</span><br><span class="line">  -- Helper function to making printing the value of a variable easier.</span><br><span class="line">  -- For example:</span><br><span class="line">  --       <span class="title function_">printPtr</span> <span class="params">(<span class="string">&quot;myVarAddr&quot;</span>, &amp;myVar)</span></span><br><span class="line">  -- prints out:</span><br><span class="line">  --       myVarAddr = <span class="number">0x0001D9C4</span></span><br><span class="line">  --</span><br><span class="line">    print (s)</span><br><span class="line">    print (<span class="string">&quot; = &quot;</span>)</span><br><span class="line">    printHex (p asInteger)</span><br><span class="line">    nl () </span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>打印指针变量名</li>
<li>打印等号</li>
<li>通过asInteger获得指针对应的地址整数值</li>
<li>使用printHex打印十六进制地址</li>
<li>打印换行符</li>
</ul>
<br>
<h2 id="112-nl-换行符"><a class="markdownIt-Anchor" href="#112-nl-换行符"></a> 1.12 nl: 换行符</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">nl</span> <span class="params">()</span></span><br><span class="line">    <span class="title function_">printChar</span> <span class="params">(<span class="string">&#x27;\n&#x27;</span>)</span></span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>打印一个换行符’\n’</li>
</ul>
<br>
<h2 id="113-printnullterminatedstring-打印空终止字符串"><a class="markdownIt-Anchor" href="#113-printnullterminatedstring-打印空终止字符串"></a> 1.13 printNullTerminatedString: 打印空终止字符串</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">printNullTerminatedString</span> <span class="params">(p: ptr to <span class="type">char</span>)</span></span><br><span class="line">  --</span><br><span class="line">  -- This function is passed a pointer to a sequence of</span><br><span class="line">  -- characters, followed by &#x27;\0&#x27;.  It prints them.</span><br><span class="line">  --</span><br><span class="line">  var ch: <span class="type">char</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line">      ch = *p</span><br><span class="line">      <span class="keyword">if</span> ch == <span class="string">&#x27;\0&#x27;</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      endIf</span><br><span class="line">      printChar (ch)</span><br><span class="line">      p = p + <span class="number">1</span></span><br><span class="line">    endWhile</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>接收一个char指针p,指向空终止字符串</li>
<li>用while循环遍历字符串
<ul>
<li>读取指针处的字符到ch</li>
<li>如果ch是空终止符’\0’,循环结束</li>
<li>否则,打印这个字符,指针p向后移一个字符</li>
</ul>
</li>
<li>循环打印完所有字符后返回</li>
</ul>
<br>
<h2 id="114-heap-定义堆内存分配器的变量"><a class="markdownIt-Anchor" href="#114-heap-定义堆内存分配器的变量"></a> 1.14 HEAP: 定义堆内存分配器的变量</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">-- The following <span class="title function_">functions</span> <span class="params">(provided below)</span> are used to implement the heap.</span><br><span class="line">--    KPLSystemInitialize</span><br><span class="line">--    KPLMemoryAlloc</span><br><span class="line">--    KPLMemoryFree</span><br><span class="line">-- The runtime system will execute calls to these routines whenever:</span><br><span class="line">--    Whenever a TRY statement is executed</span><br><span class="line">--    Whenever an ALLOC statement is executed</span><br><span class="line">--    Whenever a FREE statement is executed</span><br><span class="line">--</span><br><span class="line">-- The heap implementation provided here is overly simple: Blocks of memory</span><br><span class="line">-- are allocated sequentially and any attempt to &quot;<span class="built_in">free</span>&quot; memory is ignored.</span><br><span class="line">--</span><br><span class="line"><span class="type">const</span></span><br><span class="line">  HEAP_SIZE = <span class="number">20000</span></span><br><span class="line">var</span><br><span class="line">  memoryArea: <span class="built_in">array</span> [HEAP_SIZE] of <span class="type">char</span></span><br><span class="line">  nextCharToUse: <span class="type">int</span> = <span class="number">0</span></span><br><span class="line">  alreadyInAlloc: <span class="type">bool</span> = <span class="literal">false</span>          -- Used to detect re-entrance</span><br></pre></td></tr></table></figure>
<ul>
<li>定义了一个HEAP_SIZE常量,表示堆区的大小。</li>
<li>定义了memoryArea数组,它就是堆区的内存空间。</li>
<li>nextCharToUse变量记录下次分配的内存位置。</li>
<li>alreadyInAlloc标志用来检测重复入栈</li>
</ul>
<br>
<h2 id="115-kplsysteminitialize-系统初始化函数会在main函数被调用前执行"><a class="markdownIt-Anchor" href="#115-kplsysteminitialize-系统初始化函数会在main函数被调用前执行"></a> 1.15 KPLSystemInitialize: 系统初始化函数,会在main函数被调用前执行</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">KPLSystemInitialize</span> <span class="params">()</span></span><br><span class="line">  --</span><br><span class="line">  -- This routine is called directly before the &quot;main&quot; function is called.</span><br><span class="line">  --</span><br><span class="line">  -- Initialize the <span class="built_in">array</span> count without initializing the data.  Here we initialize</span><br><span class="line">  -- a few of the bytes in the HEAP so that we can watch out <span class="keyword">for</span> overflowing</span><br><span class="line">  -- into the frame region.</span><br><span class="line">  --</span><br><span class="line">  var p: ptr to <span class="type">int</span> = (&amp; memoryArea) asPtrTo <span class="type">int</span></span><br><span class="line">      p2: ptr to <span class="type">int</span></span><br><span class="line">    *p = HEAP_SIZE</span><br><span class="line">    <span class="keyword">for</span> p2 = p+<span class="number">4</span> to p + <span class="number">4</span> + HEAP_SIZE<span class="number">-1</span> by <span class="number">100</span></span><br><span class="line">      *p2 = <span class="number">0x48454150</span>      -- ASCII codes <span class="keyword">for</span> <span class="string">&quot;HEAP&quot;</span></span><br><span class="line">    endFor</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化memoryArea数组的大小为HEAP_SIZE,但不初始化数组内容。</li>
<li>将memoryArea数组起始地址的整数指针赋值给p。</li>
<li>在p位置赋值HEAP_SIZE,表示数组大小。</li>
<li>然后每隔100个位置,将0x48454150赋值给该位置。这是&quot;HEAP&quot;的ASCII码,目的是防止堆区溢出影响栈区。</li>
</ul>
<br>
<h2 id="116-kplmemoryalloc实现堆内存分配的函数顺序分配内存块直到内存用尽"><a class="markdownIt-Anchor" href="#116-kplmemoryalloc实现堆内存分配的函数顺序分配内存块直到内存用尽"></a> 1.16 KPLMemoryAlloc:实现堆内存分配的函数,顺序分配内存块,直到内存用尽</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">KPLMemoryAlloc</span> <span class="params">(byteCount: <span class="type">int</span>)</span> returns ptr to <span class="type">char</span></span><br><span class="line">  --</span><br><span class="line">  -- This routine is called to allocate memory from the heap.</span><br><span class="line">  -- This heap implementation is trivial: It allocates space</span><br><span class="line">  -- sequentially, until there is no more.  When space is exhausted,</span><br><span class="line">  -- we throw an error.</span><br><span class="line">  --</span><br><span class="line">  -- NOTE: THIS FUNCTION IS ***NOT*** RE-ENTRANT!!!  The caller must</span><br><span class="line">  --       ensure that it will only be called from one thread.  <span class="params">(If it might</span></span><br><span class="line"><span class="params">  --       be called from different threads, the caller must ensure that it</span></span><br><span class="line"><span class="params">  --       is protected with semaphores, mutexes, etc. from being invoked</span></span><br><span class="line"><span class="params">  --       <span class="keyword">while</span> it is already active!!!</span></span><br><span class="line"><span class="params">  --</span></span><br><span class="line"><span class="params">  var i: <span class="type">int</span></span></span><br><span class="line"><span class="params">      p: ptr to <span class="type">char</span></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    -- The following test is NOT correct!!!  But it may</span></span><br><span class="line"><span class="params">    -- detect some cases of re-entrance...</span></span><br><span class="line"><span class="params">    <span class="keyword">if</span> alreadyInAlloc</span></span><br><span class="line"><span class="params">      KPLSystemError (<span class="string">&quot;WITHIN KPLMemoryAlloc: Reentered&quot;</span>)</span></span><br><span class="line"><span class="params">    endIf</span></span><br><span class="line"><span class="params">    alreadyInAlloc = <span class="literal">true</span></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    i = nextCharToUse</span></span><br><span class="line"><span class="params">    <span class="keyword">if</span> byteCount &lt;= <span class="number">0</span></span></span><br><span class="line"><span class="params">      print (<span class="string">&quot;\n\nBad byteCount = &quot;</span>)</span></span><br><span class="line"><span class="params">      printInt (byteCount)</span></span><br><span class="line"><span class="params">      KPLSystemError (<span class="string">&quot;WITHIN KPLMemoryAlloc: byte count is not positive&quot;</span>)</span></span><br><span class="line"><span class="params">    endIf</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    -- Add <span class="number">4</span> bytes to the byte count, <span class="keyword">for</span> storing a hidden byte count.</span></span><br><span class="line"><span class="params">    byteCount = byteCount + <span class="number">4</span></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    -- Round up to a multiple of <span class="number">8.</span></span></span><br><span class="line"><span class="params">    <span class="keyword">if</span> byteCount % <span class="number">8</span> &gt; <span class="number">0</span></span></span><br><span class="line"><span class="params">      byteCount = (byteCount / <span class="number">8</span> + <span class="number">1</span>) * <span class="number">8</span></span></span><br><span class="line"><span class="params">    endIf</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    -- Uncomment the following to see when <span class="string">&quot;HEAP Alloc&quot;</span> occurs</span></span><br><span class="line"><span class="params">    <span class="comment">/*</span></span></span><br><span class="line"><span class="comment"><span class="params">    print (&quot;\n+++++ KPLMemoryAlloc   byteCount: &quot;)</span></span></span><br><span class="line"><span class="comment"><span class="params">    printInt (byteCount)</span></span></span><br><span class="line"><span class="comment"><span class="params">    print (&quot;, remaining: &quot;)</span></span></span><br><span class="line"><span class="comment"><span class="params">    printInt (HEAP_SIZE-(nextCharToUse + byteCount))</span></span></span><br><span class="line"><span class="comment"><span class="params">    print (&quot;, returns: &quot;)</span></span></span><br><span class="line"><span class="comment"><span class="params">    printHex ((&amp; (memoryArea [i])) asInteger + 4)</span></span></span><br><span class="line"><span class="comment"><span class="params">    print (&quot; +++++\n&quot;)</span></span></span><br><span class="line"><span class="comment"><span class="params">    */</span></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    nextCharToUse = nextCharToUse + byteCount</span></span><br><span class="line"><span class="params">    <span class="keyword">if</span> nextCharToUse &gt; HEAP_SIZE</span></span><br><span class="line"><span class="params">      KPLSystemError (<span class="string">&quot;WITHIN KPLMemoryAlloc: Out of memory&quot;</span>)</span></span><br><span class="line"><span class="params">    endIf</span></span><br><span class="line"><span class="params">    p = &amp; (memoryArea [i])</span></span><br><span class="line"><span class="params">    *(p asPtrTo <span class="type">int</span>) = byteCount</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    alreadyInAlloc = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">return</span> p + <span class="number">4</span></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">  endFunction</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用alreadyInAlloc标志来检测重入(非严格检测)。</li>
<li>计算要分配的内存位置i,根据nextCharToUse的值。</li>
<li>检查byteCount大小是否合法。</li>
<li>byteCount增加4字节,用于隐藏地存储分配的大小。</li>
<li>将byteCount调整为8的倍数。</li>
<li>更新nextCharToUse指针,检查是否越界。</li>
<li>在内存起始处隐藏地存储分配的大小。</li>
<li>返回结果指针(偏移4字节跳过隐藏的大小)</li>
</ul>
<br>
<h2 id="117-kplmemoryfree-释放堆内存的函数"><a class="markdownIt-Anchor" href="#117-kplmemoryfree-释放堆内存的函数"></a> 1.17 KPLMemoryFree: 释放堆内存的函数</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">KPLMemoryFree</span> <span class="params">(p: ptr to <span class="type">char</span>)</span></span><br><span class="line">  --</span><br><span class="line">  -- This routine is called to <span class="built_in">free</span> memory in the heap.  It is passed a</span><br><span class="line">  -- pointer to a block of memory previously allocated in a call to &quot;alloc&quot;.</span><br><span class="line">  --</span><br><span class="line">  -- Currently, this routine is a nop.</span><br><span class="line">  --</span><br><span class="line">    --<span class="title function_">print</span> <span class="params">(<span class="string">&quot;\n+++++ KPLMemoryFree called... ptr: &quot;</span>)</span></span><br><span class="line">    --<span class="title function_">printHex</span> <span class="params">(p asInteger)</span></span><br><span class="line">    --<span class="title function_">print</span> <span class="params">(<span class="string">&quot; +++++\n&quot;</span>)</span></span><br><span class="line">  endFunction</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<br>
<h2 id="118-kplsystemerror运行时错误处理函数当出现严重错误时会被调用"><a class="markdownIt-Anchor" href="#118-kplsystemerror运行时错误处理函数当出现严重错误时会被调用"></a> 1.18 KPLSystemError:运行时错误处理函数,当出现严重错误时会被调用</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">KPLSystemError</span> <span class="params">(message: ptr to <span class="built_in">array</span> of <span class="type">char</span>)</span></span><br><span class="line">  --</span><br><span class="line">  -- Come here when a fatal error occurs.  Print a message and <span class="built_in">terminate</span></span><br><span class="line">  -- the KPL program.  There will be no <span class="keyword">return</span> from this function.</span><br><span class="line">  -- NOTE: This function is not aware of threads; it is better to use FatalError</span><br><span class="line">  -- (from the Thread package) <span class="keyword">if</span> possible.</span><br><span class="line">  --</span><br><span class="line">    print (<span class="string">&quot;\n\nFATAL KPL RUNTIME ERROR: &quot;</span>)</span><br><span class="line">    print (message)</span><br><span class="line">    nl ()</span><br><span class="line">    RuntimeExit ()</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>打印错误消息。</li>
<li>打印一个空行。</li>
<li>调用RuntimeExit退出程序</li>
</ul>
<br>
<h2 id="119-internal-runtime-data-structures-运行时的内部数据结构"><a class="markdownIt-Anchor" href="#119-internal-runtime-data-structures-运行时的内部数据结构"></a> 1.19 Internal Runtime Data Structures: 运行时的内部数据结构</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">--</span><br><span class="line">-- These data structures are intimately connected with the language</span><br><span class="line">-- implementation and the compiler, and can safely be ignored by</span><br><span class="line">-- KPL programmers.  They should not be changed without appropriate</span><br><span class="line">-- modifications to the compiler.</span><br><span class="line">--</span><br><span class="line">type</span><br><span class="line">  -- The following record has a fixed format:</span><br><span class="line">  CATCH_RECORD = record</span><br><span class="line">                   next: ptr to CATCH_RECORD</span><br><span class="line">                   errorID: ptr to <span class="type">char</span>    -- Null terminated <span class="built_in">string</span></span><br><span class="line">                   catchCodePtr: <span class="type">int</span>       -- Address of the code</span><br><span class="line">                   oldFP: <span class="type">int</span></span><br><span class="line">                   oldSP: <span class="type">int</span></span><br><span class="line">                   fileName: ptr to <span class="type">char</span>   -- Null terminated <span class="built_in">string</span></span><br><span class="line">                   lineNumber: <span class="type">int</span></span><br><span class="line">                 endRecord</span><br><span class="line"></span><br><span class="line">  -- The following record has a fixed format:</span><br><span class="line">  DISPATCH_TABLE = record</span><br><span class="line">                     classDescriptor: ptr to CLASS_DESCRIPTOR</span><br><span class="line">                     firstMethodPtr: <span class="type">int</span>    -- Address of code</span><br><span class="line">                   endRecord</span><br><span class="line"></span><br><span class="line">  -- The following record has a fixed format:</span><br><span class="line">  CLASS_DESCRIPTOR = record</span><br><span class="line">                       magic: <span class="type">int</span>                -- Should be <span class="number">0x434C4153</span> == <span class="string">&#x27;CLAS&#x27;</span></span><br><span class="line">                       myName: ptr to <span class="type">char</span>       -- Null terminated <span class="built_in">string</span></span><br><span class="line">                       fileName: ptr to <span class="type">char</span>     -- Null terminated <span class="built_in">string</span></span><br><span class="line">                       lineNumber: <span class="type">int</span></span><br><span class="line">                       sizeInBytes: <span class="type">int</span></span><br><span class="line">                       firstSuperPtr: ptr to DISPATCH_TABLE</span><br><span class="line">                     endRecord</span><br><span class="line"></span><br><span class="line">  -- The following record has a fixed format:</span><br><span class="line">  INTERFACE_DESCRIPTOR = record</span><br><span class="line">                           magic: <span class="type">int</span>                -- Should be <span class="number">0x494E5446</span> == <span class="string">&#x27;INTF&#x27;</span></span><br><span class="line">                           myName: ptr to <span class="type">char</span>       -- Null terminated <span class="built_in">string</span></span><br><span class="line">                           fileName: ptr to <span class="type">char</span>     -- Null terminated <span class="built_in">string</span></span><br><span class="line">                           lineNumber: <span class="type">int</span></span><br><span class="line">                           firstInterfacePtr: ptr to INTERFACE_DESCRIPTOR</span><br><span class="line">                         endRecord</span><br><span class="line"></span><br><span class="line">  -- The following record has a fixed format:</span><br><span class="line">  OBJECT_RECORD = record</span><br><span class="line">                    dispatchTable: ptr to DISPATCH_TABLE</span><br><span class="line">                    firstField: <span class="type">int</span></span><br><span class="line">                  endRecord</span><br></pre></td></tr></table></figure>
<ul>
<li>CATCH_RECORD:用于实现异常捕获机制的catch记录。</li>
<li>DISPATCH_TABLE:用于方法分派的表记录。</li>
<li>CLASS_DESCRIPTOR:类描述符,包含类信息。</li>
<li>INTERFACE_DESCRIPTOR:接口描述符,包含接口信息。</li>
<li>OBJECT_RECORD:对象记录,包含对象的分派表指针等信息</li>
</ul>
<br>
<h2 id="120-kpliskindof可以判断一个对象是否是某个类的实例或实现了某个接口"><a class="markdownIt-Anchor" href="#120-kpliskindof可以判断一个对象是否是某个类的实例或实现了某个接口"></a> 1.20 KPLIsKindOf:可以判断一个对象是否是某个类的实例,或实现了某个接口</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">KPLIsKindOf</span> <span class="params">(objPtr: ptr to Object, typeDesc: ptr to <span class="type">int</span>)</span> returns <span class="type">int</span></span><br><span class="line">  --</span><br><span class="line">  -- There will be an upcall from the runtime system to this function, which</span><br><span class="line">  -- will evaluate the &quot;isKindOf&quot; relation.  This routine determines whether</span><br><span class="line">  -- the object pointed to satisfies the &quot;isKindOf&quot; relation, i.e., whether it</span><br><span class="line">  -- is an instance of the given type, or of one of its super-classes or super-</span><br><span class="line">  -- interfaces.  It returns either 0 <span class="params">(<span class="keyword">for</span> FALSE)</span> or 1 <span class="params">(<span class="keyword">for</span> TRUE)</span>.</span><br><span class="line">  --</span><br><span class="line">    var</span><br><span class="line">      dispTable: ptr to DISPATCH_TABLE</span><br><span class="line">      classDesc: ptr to CLASS_DESCRIPTOR</span><br><span class="line">      next: ptr to ptr to <span class="type">void</span></span><br><span class="line"> </span><br><span class="line">    -- We should never be passed a <span class="literal">NULL</span> pointer, but check anyway.</span><br><span class="line">    <span class="keyword">if</span> objPtr == null</span><br><span class="line">      KPLSystemError (<span class="string">&quot;WITHIN KPLIsKindOf: objPtr is NULL&quot;</span>)</span><br><span class="line">    endIf</span><br><span class="line"></span><br><span class="line">    -- If the object is uninitialized <span class="keyword">return</span> <span class="literal">false</span>.</span><br><span class="line">    dispTable = (objPtr asPtrTo OBJECT_RECORD).dispatchTable</span><br><span class="line">    <span class="keyword">if</span> dispTable == null</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    endIf</span><br><span class="line"></span><br><span class="line">    classDesc = dispTable.classDescriptor</span><br><span class="line"></span><br><span class="line">    -- Make sure the magic number is what we expect it to be.</span><br><span class="line">    <span class="keyword">if</span> classDesc.magic != <span class="number">0x434C4153</span>   -- <span class="string">&#x27;CLAS&#x27;</span></span><br><span class="line">      KPLSystemError (<span class="string">&quot;WITHIN KPLIsKindOf: Bad Magic Number&quot;</span>)</span><br><span class="line">    endIf</span><br><span class="line"></span><br><span class="line">    -- Run through all supers.  (Each class is a super of itself.)</span><br><span class="line">    next = &amp; classDesc.firstSuperPtr</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line">      <span class="keyword">if</span> *next == null</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">      elseIf *next == typeDesc</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">      endIf</span><br><span class="line">      next = next + <span class="number">4</span></span><br><span class="line">    endWhile</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>检查对象指针是否为空。</li>
<li>获取对象的分派表。</li>
<li>检查魔数是否正确。</li>
<li>遍历对象的所有父类和接口。</li>
<li>如果匹配到给定的类型描述符,返回true,否则返回false。</li>
</ul>
<br>
<h2 id="121-kpluncaughtthrow异常没有被捕获时的处理函数"><a class="markdownIt-Anchor" href="#121-kpluncaughtthrow异常没有被捕获时的处理函数"></a> 1.21 KPLUncaughtThrow:异常没有被捕获时的处理函数</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">KPLUncaughtThrow</span> <span class="params">(errorID: ptr to <span class="type">char</span>, line: <span class="type">int</span>, rPtr: <span class="type">int</span>)</span></span><br><span class="line">  --</span><br><span class="line">  -- Whenever an error is thrown but not caught, there will be an upcall from the</span><br><span class="line">  -- runtime system to this function.  <span class="params">(Exception: <span class="keyword">if</span> <span class="string">&quot;UncaughtThrowError&quot;</span> is thrown</span></span><br><span class="line"><span class="params">  -- but not caught, it will cause a fatal runtime error.)</span>  This function will</span><br><span class="line">  -- print some info about the error that was thrown, then it will throw an</span><br><span class="line">  -- error called &quot;UncaughtThrowError&quot;.  This error may or may not be caught by</span><br><span class="line">  -- the user&#x27;s code.  If not, the runtime system will simply print an error and halt.</span><br><span class="line">  --</span><br><span class="line">    var</span><br><span class="line">      charPtr: ptr to <span class="type">char</span></span><br><span class="line">    <span class="title function_">print</span> <span class="params">(<span class="string">&quot;\n\n++++++++++ An error has been thrown but not caught ++++++++++\n&quot;</span>)</span></span><br><span class="line">    <span class="title function_">print</span> <span class="params">(<span class="string">&quot;   Error Name = &quot;</span>)</span></span><br><span class="line">    <span class="title function_">printNullTerminatedString</span> <span class="params">(errorID)</span></span><br><span class="line">    <span class="title function_">nl</span> <span class="params">()</span></span><br><span class="line">    <span class="title function_">print</span> <span class="params">(<span class="string">&quot;   Location at time of THROW = &quot;</span>)</span></span><br><span class="line">    charPtr = * (rPtr asPtrTo ptr to <span class="type">char</span>)</span><br><span class="line">    printNullTerminatedString (charPtr)</span><br><span class="line">    print (<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    printInt (line)</span><br><span class="line">    nl ()</span><br><span class="line">    print (<span class="string">&quot;   Currently active method or function = &quot;</span>)</span><br><span class="line">    rPtr = rPtr + <span class="number">4</span></span><br><span class="line">    charPtr = * (rPtr asPtrTo ptr to <span class="type">char</span>)</span><br><span class="line">    printNullTerminatedString (charPtr)</span><br><span class="line">    nl ()</span><br><span class="line">    printCatchStack ()</span><br><span class="line">    print (<span class="string">&quot;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n\n&quot;</span>)</span><br><span class="line">    throw UncaughtThrowError (errorID, line, rPtr)</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>打印一些未捕获错误的信息,包括错误名称、抛出位置、当前调用方法等。</li>
<li>调用printCatchStack打印当前的捕获栈。</li>
<li>抛出一个UncaughtThrowError错误。</li>
<li>如果UncaughtThrowError还是没有被捕获,运行时系统会打印错误信息并终止程序</li>
</ul>
<br>
<h2 id="122-printcatchstack打印当前的异常捕获栈信息"><a class="markdownIt-Anchor" href="#122-printcatchstack打印当前的异常捕获栈信息"></a> 1.22 printCatchStack:打印当前的异常捕获栈信息</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">printCatchStack</span> <span class="params">()</span></span><br><span class="line">  --</span><br><span class="line">  -- Print all CATCH_RECORDs on the CATCH_STACK.</span><br><span class="line">  --</span><br><span class="line">  -- NOTE: Whenever we leave the body statements in a <span class="title function_">try</span> <span class="params">(i.e., fall-thru,</span></span><br><span class="line"><span class="params">  --       throw, or <span class="keyword">return</span>)</span>, records from the catch <span class="built_in">stack</span> will be popped and</span><br><span class="line">  --       freed.  &quot;getCatchStack&quot; returns a pointer to a <span class="built_in">list</span> of CATCH_RECORDs</span><br><span class="line">  --       as it is when getCatchStack is called.  This routine merely reads data</span><br><span class="line">  --       from these records, so additional pushing and popping is okay and may</span><br><span class="line">  --       <span class="title function_">occur</span> <span class="params">(e.g., we call <span class="string">&quot;print&quot;</span>, which may contain TRY statements)</span>.  However,</span><br><span class="line">  --       none of the records on the <span class="built_in">list</span> returned by getCatchStack will be freed</span><br><span class="line">  --       before this routine is done looking at and printing them.</span><br><span class="line">  --</span><br><span class="line">  var p: ptr to CATCH_RECORD = getCatchStack () asPtrTo CATCH_RECORD</span><br><span class="line">    <span class="title function_">print</span> <span class="params">(<span class="string">&quot;   Here is the CATCH STACK:\n&quot;</span>)</span></span><br><span class="line">    <span class="keyword">while</span> p</span><br><span class="line">      <span class="title function_">print</span> <span class="params">(<span class="string">&quot;     &quot;</span>)</span></span><br><span class="line">      <span class="title function_">printNullTerminatedString</span> <span class="params">(p.fileName)</span></span><br><span class="line">      <span class="title function_">print</span> <span class="params">(<span class="string">&quot;:&quot;</span>)</span></span><br><span class="line">      <span class="title function_">printInt</span> <span class="params">(p. lineNumber)</span></span><br><span class="line">      <span class="title function_">print</span> <span class="params">(<span class="string">&quot;:\t&quot;</span>)</span></span><br><span class="line">      <span class="title function_">printNullTerminatedString</span> <span class="params">(p.errorID)</span></span><br><span class="line">      --<span class="title function_">print</span> <span class="params">(<span class="string">&quot;\t\t(CATCH-RECORD addr = 0x&quot;</span>)</span></span><br><span class="line">      --<span class="title function_">printHex</span> <span class="params">(p asInteger)</span></span><br><span class="line">      --<span class="title function_">print</span> <span class="params">(<span class="string">&quot;)&quot;</span>)</span></span><br><span class="line">      <span class="title function_">nl</span> <span class="params">()</span></span><br><span class="line">      <span class="comment">/**********</span></span><br><span class="line"><span class="comment">      print (&quot;     &quot;)</span></span><br><span class="line"><span class="comment">      printNullTerminatedString (p.errorID)</span></span><br><span class="line"><span class="comment">      print (&quot;\n        Source Filename:   &quot;)</span></span><br><span class="line"><span class="comment">      printNullTerminatedString (p.fileName)</span></span><br><span class="line"><span class="comment">      print (&quot;\n        Line number:       &quot;)</span></span><br><span class="line"><span class="comment">      printInt (p. lineNumber)</span></span><br><span class="line"><span class="comment">      print (&quot;\n        Catch record addr: &quot;)</span></span><br><span class="line"><span class="comment">      printHex (p asInteger)</span></span><br><span class="line"><span class="comment">      print (&quot;\n        Catch code addr:   &quot;)</span></span><br><span class="line"><span class="comment">      printHex (p.catchCodePtr)</span></span><br><span class="line"><span class="comment">      print (&quot;\n        Old FP:            &quot;)</span></span><br><span class="line"><span class="comment">      printHex (p.oldFP)</span></span><br><span class="line"><span class="comment">      print (&quot;\n        Old SP:            &quot;)</span></span><br><span class="line"><span class="comment">      printHex (p.oldSP)</span></span><br><span class="line"><span class="comment">      nl ()</span></span><br><span class="line"><span class="comment">      **********/</span></span><br><span class="line">      p = p.next</span><br><span class="line">    endWhile</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>通过getCatchStack()获取捕获栈。</li>
<li>遍历捕获栈中的每一个CATCH_RECORD。</li>
<li>打印CATCH_RECORD的相关信息,包括源文件名、行号、错误名等。</li>
</ul>
<br>
<h2 id="2-runtimes"><a class="markdownIt-Anchor" href="#2-runtimes"></a> 2. <code>Runtime.s</code></h2>
<p>“KPL”编程语言的运行时环境所写的汇编代码</p>
<br>
<h2 id="3-threadc"><a class="markdownIt-Anchor" href="#3-threadc"></a> 3. <code>Thread.c</code></h2>
<p>实现基本的线程调度器和线程对象</p>
<br>
<h2 id="31-initializescheduler线程调度器的初始化"><a class="markdownIt-Anchor" href="#31-initializescheduler线程调度器的初始化"></a> 3.1 InitializeScheduler:线程调度器的初始化</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">InitializeScheduler</span> <span class="params">()</span></span><br><span class="line">  --</span><br><span class="line">  -- This routine assumes that we are in System mode.  It sets up the</span><br><span class="line">  -- thread scheduler and turns the executing program into &quot;main-thread&quot;.</span><br><span class="line">  -- After <span class="built_in">exit</span>, we can execute &quot;Yield&quot;, &quot;Fork&quot;, etc.  Upon <span class="keyword">return</span>, the</span><br><span class="line">  -- main-thread will be executing with interrupts enabled.</span><br><span class="line">  --</span><br><span class="line">    <span class="title function_">Cleari</span> <span class="params">()</span></span><br><span class="line">    <span class="title function_">print</span> <span class="params">(<span class="string">&quot;Initializing Thread Scheduler...\n&quot;</span>)</span></span><br><span class="line">    readyList = new List [Thread]</span><br><span class="line">    threadsToBeDestroyed = new List [Thread]</span><br><span class="line">    mainThread = new Thread</span><br><span class="line">    mainThread.Init (<span class="string">&quot;main-thread&quot;</span>)</span><br><span class="line">    mainThread.status = RUNNING</span><br><span class="line">    idleThread = new Thread</span><br><span class="line">    idleThread.Init (<span class="string">&quot;idle-thread&quot;</span>)</span><br><span class="line">    idleThread.Fork (IdleFunction, <span class="number">0</span>)</span><br><span class="line">    currentThread = &amp; mainThread</span><br><span class="line">    currentInterruptStatus = ENABLED</span><br><span class="line">    Seti ()</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>清除中断标志Cleari(),确保在初始化过程中不会被中断。</li>
<li>创建readyList来保存可运行的线程。</li>
<li>创建threadsToBeDestroyed列表,用于保存已结束需要销毁的线程。</li>
<li>创建主线程mainThread,名称为&quot;main-thread&quot;,状态为运行中RUNNING。</li>
<li>创建空闲线程idleThread,名称为&quot;idle-thread&quot;。</li>
<li>用IdleFunction作为入口把idleThread线程fork出去执行。</li>
<li>当前线程currentThread设置为mainThread。</li>
<li>中断状态currentInterruptStatus置为ENABLED。</li>
<li>打开中断Seti()</li>
</ul>
<br>
<h2 id="32-idlefunction空闲线程守护线程的作用确保当没有线程运行时不会发生错误并可以快速响应下一个外部中断或线程的到来"><a class="markdownIt-Anchor" href="#32-idlefunction空闲线程守护线程的作用确保当没有线程运行时不会发生错误并可以快速响应下一个外部中断或线程的到来"></a> 3.2 IdleFunction:空闲线程,守护线程的作用,确保当没有线程运行时不会发生错误,并可以快速响应下一个外部中断或线程的到来</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">IdleFunction</span> <span class="params">(arg: <span class="type">int</span>)</span></span><br><span class="line">  --</span><br><span class="line">  -- This is the &quot;idle thread&quot;, a kernel thread which ensures that the ready</span><br><span class="line">  -- <span class="built_in">list</span> is never empty.  The idle thread constantly yields to other threads</span><br><span class="line">  -- in an infinite loop.  However, before yielding, it first checks to see <span class="keyword">if</span></span><br><span class="line">  -- there are other threads.  If there are no other threads, the idle thread</span><br><span class="line">  -- will execute the &quot;wait&quot; instruction.  The &quot;wait&quot; instruction will enable</span><br><span class="line">  -- interrupts and halt CPU execution until the next interrupt arrives.</span><br><span class="line">  --</span><br><span class="line">    var junk: <span class="type">int</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line">      junk = SetInterruptsTo (DISABLED)</span><br><span class="line">      <span class="keyword">if</span> readyList.IsEmpty ()</span><br><span class="line">        Wait ()</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        currentThread.Yield ()</span><br><span class="line">      endIf</span><br><span class="line">    endWhile</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>它是一个无限循环的线程。</li>
<li>在每次循环开始,先禁用中断SetInterruptsTo(DISABLED),保证对readyList的访问互斥。</li>
<li>检查readyList是否为空,如果为空,执行Wait()指令,它会打开中断并等待下一个中断到来。</li>
<li>如果readyList不为空,调用currentThread.Yield()来切换到下一个线程运行。<br />
回到循环开始</li>
</ul>
<p>当没有正常的线程在运行时,IDLE线程就会等待中断,从而避免CPU空转。</p>
<p>一旦有线程ready,IDLE线程就会把CPU时间片让给那个线程</p>
<br>
<h2 id="33-run线程切换保存和切换当前线程context并改变currentthread指针实现了线程之间无缝的切换"><a class="markdownIt-Anchor" href="#33-run线程切换保存和切换当前线程context并改变currentthread指针实现了线程之间无缝的切换"></a> 3.3 Run:线程切换,保存和切换当前线程context,并改变currentThread指针,实现了线程之间无缝的切换</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">Run</span> <span class="params">(nextThread: ptr to Thread)</span></span><br><span class="line">  --</span><br><span class="line">  -- Begin executing the thread &quot;nextThread&quot;, which has already</span><br><span class="line">  -- been removed from the readyList.  The current thread will</span><br><span class="line">  -- be suspended; we assume that its status has already been</span><br><span class="line">  -- changed to READY or BLOCKED.  We assume that interrupts are</span><br><span class="line">  -- DISABLED when called.</span><br><span class="line">  --</span><br><span class="line">  -- This routine is called only from <span class="string">&quot;Thread.Yield&quot;</span> and <span class="string">&quot;Thread.Sleep&quot;</span>.</span><br><span class="line">  --</span><br><span class="line">    var prevThread, th: ptr to Thread</span><br><span class="line">    prevThread = currentThread</span><br><span class="line">    prevThread.CheckOverflow ()</span><br><span class="line">    currentThread = nextThread</span><br><span class="line">    nextThread.status = RUNNING</span><br><span class="line">    --print (<span class="string">&quot;SWITCHING from &quot;</span>)</span><br><span class="line">    --print (prevThread.name)</span><br><span class="line">    --print (<span class="string">&quot; to &quot;</span>)</span><br><span class="line">    --print (nextThread.name)</span><br><span class="line">    --print (<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    Switch (prevThread, nextThread)</span><br><span class="line">    --print (<span class="string">&quot;After SWITCH, back in thread &quot;</span>)</span><br><span class="line">    --print (currentThread.name)</span><br><span class="line">    --print (<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> ! threadsToBeDestroyed.IsEmpty ()</span><br><span class="line">      th = threadsToBeDestroyed.Remove()</span><br><span class="line">      th.status = UNUSED</span><br><span class="line">    endWhile</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>参数nextThread表示将要切换到运行的下一个线程。</li>
<li>prevThread保存当前线程currentThread。</li>
<li>检查prevThread的栈是否溢出。</li>
<li>将nextThread设置为当前线程currentThread。</li>
<li>将nextThread的状态设置为RUNNING。</li>
<li>调用Switch完成线程栈和寄存器的切换。<br />
-在线程切换后,如果有已结束的线程在threadsToBeDestroyed列表中,则将其状态设置为UNUSED释放。</li>
<li>返回到新线程nextThread的执行中</li>
</ul>
<br>
<h2 id="34-printreadylist打印readylist中的线程列表"><a class="markdownIt-Anchor" href="#34-printreadylist打印readylist中的线程列表"></a> 3.4 PrintReadyList:打印readyList中的线程列表</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">PrintReadyList</span> <span class="params">()</span></span><br><span class="line">  --</span><br><span class="line">  -- This routine prints the readyList.  It disables interrupts during the</span><br><span class="line">  -- printing to guarantee that the readyList won&#x27;t change <span class="keyword">while</span> it is</span><br><span class="line">  -- being printed, which could cause disaster in this routine!</span><br><span class="line">  --</span><br><span class="line">  var oldStatus: <span class="type">int</span></span><br><span class="line">    oldStatus = SetInterruptsTo (DISABLED)</span><br><span class="line">      print (<span class="string">&quot;Here is the ready list:\n&quot;</span>)</span><br><span class="line">      readyList.ApplyToEach (ThreadPrint)</span><br><span class="line">    oldStatus = SetInterruptsTo (oldStatus)</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>首先保存中断状态oldStatus,并禁用中断SetInterruptsTo(DISABLED)。 这能防止readyList在打印过程中被修改,造成混乱。</li>
<li>打印提示信息,表示将打印readyList。</li>
<li>调用readyList的ApplyToEach来遍历列表中的每个线程,调用ThreadPrint打印每个线程的信息。</li>
<li>打印完成后恢复之前的中断状态oldStatus。</li>
</ul>
<p>通过临时禁用中断,保证了readyList的一致性,避免打印过程中因线程调度而列表内容改变,导致打印逻辑混乱</p>
<br>
<h2 id="35-threadstartmain每个线程真正开始运行时的入口函数"><a class="markdownIt-Anchor" href="#35-threadstartmain每个线程真正开始运行时的入口函数"></a> 3.5 ThreadStartMain:每个线程真正开始运行时的入口函数</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">ThreadStartMain</span> <span class="params">()</span></span><br><span class="line">  --</span><br><span class="line">  -- This function is called from the assembly language routine &quot;ThreadStart&quot;.</span><br><span class="line">  -- It is the first KPL code each thread will execute, and it will</span><br><span class="line">  -- invoke the thread&#x27;s &quot;main&quot; function, with interrupts enabled.  If the &quot;main&quot;</span><br><span class="line">  -- function ever returns, this function will <span class="built_in">terminate</span> this thread.  This</span><br><span class="line">  -- function will never <span class="keyword">return</span>.</span><br><span class="line">  --</span><br><span class="line">    var</span><br><span class="line">      junk: <span class="type">int</span></span><br><span class="line">      mainFun: ptr to <span class="title function_">function</span> <span class="params">(<span class="type">int</span>)</span></span><br><span class="line">    -- <span class="title function_">print</span> <span class="params">(<span class="string">&quot;ThreadStartMain...\n&quot;</span>)</span></span><br><span class="line">    junk = SetInterruptsTo (ENABLED)</span><br><span class="line">    mainFun = currentThread.initialFunction</span><br><span class="line">    mainFun (currentThread.initialArgument)</span><br><span class="line">    ThreadFinish ()</span><br><span class="line">    FatalError (<span class="string">&quot;ThreadFinish should never return&quot;</span>)</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>它在汇编语言中的ThreadStart函数中被调用。</li>
<li>首先打开中断SetInterruptsTo(ENABLED)。</li>
<li>从currentThread中获取initialFunction和initialArgument,也就是在调用Thread.Fork时传递的函数和参数。</li>
<li>调用initialFunction,开始执行线程的主体逻辑。</li>
<li>如果initialFunction返回,调用ThreadFinish结束线程。</li>
<li>ThreadFinish不应该返回,如果返回就报错。</li>
<li>ThreadStartMain函数自己也不应该返回</li>
</ul>
<p>通过调用线程的主函数,传入初始化的参数,完成了线程代码的执行,打开中断允许线程运行过程中响应中断,ThreadStartMain不返回,线程主体函数返回则结束线程,这实现了一个线程生命周期的完整过程。</p>
<br>
<h2 id="36-threadfinish正常结束一个线程"><a class="markdownIt-Anchor" href="#36-threadfinish正常结束一个线程"></a> 3.6 ThreadFinish：正常结束一个线程</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">ThreadFinish</span> <span class="params">()</span></span><br><span class="line">  --</span><br><span class="line">  -- As the last thing to <span class="keyword">do</span> in this thread, we want to clean up</span><br><span class="line">  -- and reclaim the Thread object.  This method is called as the</span><br><span class="line">  -- last thing the thread does; this is the normal way <span class="keyword">for</span> a thread</span><br><span class="line">  -- to die.  However, since the thread is still running in this,</span><br><span class="line">  -- we can<span class="number">&#x27;</span>t actually <span class="keyword">do</span> the clean up.  So we just make a note</span><br><span class="line">  -- that it is pending.  After the next thread <span class="title function_">starts</span> <span class="params">(in method <span class="string">&quot;Run&quot;</span>)</span></span><br><span class="line">  -- we&#x27;ll finish the job.</span><br><span class="line">  --</span><br><span class="line">    var junk: <span class="type">int</span></span><br><span class="line">    junk = SetInterruptsTo (DISABLED)</span><br><span class="line">    -- print (<span class="string">&quot;Finishing &quot;</span>)</span><br><span class="line">    -- print (currentThread.name)</span><br><span class="line">    -- print (<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    threadsToBeDestroyed.AddToEnd (currentThread)</span><br><span class="line">    currentThread.Sleep ()</span><br><span class="line">    -- Execution will never reach the next instruction</span><br><span class="line">    debug</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>禁用中断SetInterruptsTo(DISABLED),保证操作的原子性。</li>
<li>将当前线程currentThread添加到threadsToBeDestroyed列表中,标记其需要被销毁。</li>
<li>调用currentThread.Sleep()切换到其它线程。</li>
<li>由于切换了线程,当前线程的代码不会继续执行。</li>
<li>在线程下一轮调度切换回来时,Run函数会从threadsToBeDestroyed列表中删除并回收这个线程对象。</li>
</ul>
<p>ThreadFinish允许线程在运行过程中自行结束,而不是等待线程函数返回.通过标记待销毁,并立即切换走避免当前线程继续运行,实现了正常的线程结束。</p>
<br>
<h2 id="37-fatalerror报错并终止程序的函数"><a class="markdownIt-Anchor" href="#37-fatalerror报错并终止程序的函数"></a> 3.7 FatalError:报错并终止程序的函数</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">FatalError</span> <span class="params">(errorMessage: ptr to <span class="built_in">array</span> of <span class="type">char</span>)</span></span><br><span class="line">  --</span><br><span class="line">  -- Print out the name of the current thread and the given error message.</span><br><span class="line">  -- Then <span class="built_in">abort</span> execution.</span><br><span class="line">  --</span><br><span class="line">    var</span><br><span class="line">      junk: <span class="type">int</span></span><br><span class="line">    junk = SetInterruptsTo (DISABLED)</span><br><span class="line">    print (<span class="string">&quot;\nFATAL ERROR&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> currentThread    -- If <span class="keyword">case</span> errors occur before thread initialization</span><br><span class="line">      <span class="title function_">print</span> <span class="params">(<span class="string">&quot; in &quot;</span>)</span></span><br><span class="line">      <span class="title function_">print</span> <span class="params">(currentThread.name)</span></span><br><span class="line">    endIf</span><br><span class="line">    <span class="title function_">print</span> <span class="params">(<span class="string">&quot;: \&quot;&quot;</span>)</span></span><br><span class="line">    <span class="title function_">print</span> <span class="params">(errorMessage)</span></span><br><span class="line">    <span class="title function_">print</span> <span class="params">(<span class="string">&quot;\&quot; -- TERMINATING!\n&quot;</span>)</span></span><br><span class="line">    <span class="title function_">RuntimeExit</span> <span class="params">()</span></span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>禁用中断SetInterruptsTo(DISABLED),确保打印和退出的原子性。</li>
<li>打印出&quot;FATAL ERROR&quot;标志。</li>
<li>如果当前线程已初始化,<a target="_blank" rel="noopener" href="http://xn--currentThread-hn2vy1b87jl4cg05f35l3t9inwua.name">打印出当前线程名currentThread.name</a>。</li>
<li>打印传入的错误消息errorMessage。</li>
<li>打印出&quot;-- TERMINATING!&quot;标志。</li>
<li>调用RuntimeExit终止执行。</li>
</ul>
<p>通过在错误发生时禁用中断,可以保证打印错误信息和终止程序的原子性,避免错误条件下非确定的执行流程。同时打印出线程名和错误信息,辅助debug。</p>
<br>
<h2 id="38-setinterruptsto设置中断状态"><a class="markdownIt-Anchor" href="#38-setinterruptsto设置中断状态"></a> 3.8 SetInterruptsTo:设置中断状态</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">SetInterruptsTo</span> <span class="params">(newStatus: <span class="type">int</span>)</span> returns <span class="type">int</span></span><br><span class="line">  --</span><br><span class="line">  -- This routine is passed a <span class="title function_">status</span> <span class="params">(DISABLED or ENABLED)</span>.  It</span><br><span class="line">  -- returns the previous interrupt status and sets the interrupt</span><br><span class="line">  -- status to &quot;newStatus&quot;.</span><br><span class="line">  --</span><br><span class="line">  -- Since this routine reads and modifies a shared variable</span><br><span class="line">  -- <span class="params">(currentInterruptStatus)</span>, there is a danger of this routine</span><br><span class="line">  -- being re-entered.  Therefore, it momentarily will disable</span><br><span class="line">  -- interrupts, to ensure a valid update to this variable.</span><br><span class="line">  --</span><br><span class="line">    var</span><br><span class="line">      oldStat: <span class="type">int</span></span><br><span class="line">    <span class="title function_">Cleari</span> <span class="params">()</span></span><br><span class="line">    oldStat = currentInterruptStatus</span><br><span class="line">    <span class="keyword">if</span> newStatus == ENABLED</span><br><span class="line">      currentInterruptStatus = ENABLED</span><br><span class="line">      Seti ()</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      currentInterruptStatus = DISABLED</span><br><span class="line">      Cleari ()</span><br><span class="line">    endIf</span><br><span class="line">    <span class="keyword">return</span> oldStat</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>首先清除中断Cleari(),临时禁用中断。</li>
<li>保存当前中断状态oldStat。</li>
<li>根据newStatus来设置currentInterruptStatus为ENABLED或DISABLED。</li>
<li>如果需要打开中断,调用Seti()。</li>
<li>返回之前保存的旧的中断状态oldStat。</li>
</ul>
<p>由于currentInterruptStatus是一个全局共享变量,为了确保其改变的原子性,在更新时需要临时禁用中断。这样可以避免并发的修改导致currentInterruptStatus值异常。通过保存旧状态并返回,调用者可以在操作完成后恢复到之前的中断状态</p>
<br>
<h2 id="39-timerinterrupthandler时间中断的处理函数"><a class="markdownIt-Anchor" href="#39-timerinterrupthandler时间中断的处理函数"></a> 3.9 TimerInterruptHandler:时间中断的处理函数</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">TimerInterruptHandler</span> <span class="params">()</span></span><br><span class="line">  --</span><br><span class="line">  -- This routine is called when a timer interrupt occurs.  Upon entry,</span><br><span class="line">  -- interrupts are DISABLED.  Upon <span class="keyword">return</span>, execution will <span class="keyword">return</span> to</span><br><span class="line">  -- the interrupted process, which necessarily had interrupts ENABLED.</span><br><span class="line">  --</span><br><span class="line">  -- <span class="params">(If you wish to turn time-slicing off, simply disable the call</span></span><br><span class="line"><span class="params">  -- to <span class="string">&quot;Yield&quot;</span> in the code below.  Threads will then execute until they</span></span><br><span class="line"><span class="params">  -- call <span class="string">&quot;Yield&quot;</span> explicitly, or until they call <span class="string">&quot;Sleep&quot;</span>.)</span></span><br><span class="line">  --</span><br><span class="line">    currentInterruptStatus = DISABLED</span><br><span class="line">    -- printChar (<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">    currentThread.Yield ()</span><br><span class="line">    currentInterruptStatus = ENABLED</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>进入时中断已经被DISABLE。</li>
<li>设置currentInterruptStatus为DISABLED。</li>
<li>调用currentThread.Yield()进行线程调度,切换到下一个线程。 这里实现了基于时间片的抢占式调度。</li>
<li>切换回来后,恢复currentInterruptStatus为ENABLED。</li>
<li>于是在返回到中断线程时,中断已经被重新ENABLE。</li>
</ul>
<p>通过在时间中断里调用Yield来实现时间片轮转调度。如果去掉Yield调用,则线程会一直运行,只能主动交出CPU。</p>
<br>
<h2 id="310-threadprint-打印一个线程的信息"><a class="markdownIt-Anchor" href="#310-threadprint-打印一个线程的信息"></a> 3.10 ThreadPrint: 打印一个线程的信息</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">ThreadPrint</span> <span class="params">(t: ptr to Thread)</span></span><br><span class="line">  --</span><br><span class="line">  -- This function prints a single line giving the name of thread &quot;t&quot;,</span><br><span class="line">  -- its status, and the address of the Thread object <span class="title function_">itself</span> <span class="params">(which may be</span></span><br><span class="line"><span class="params">  -- helpful in disnguishing Threads when the name is not helpful)</span>.</span><br><span class="line">  --</span><br><span class="line">    var</span><br><span class="line">      oldStatus: <span class="type">int</span> = SetInterruptsTo (DISABLED)</span><br><span class="line">    print (<span class="string">&quot;  Thread \&quot;&quot;</span>)</span><br><span class="line">    print (t.name)</span><br><span class="line">    print (<span class="string">&quot;\&quot;    status=&quot;</span>)</span><br><span class="line">    <span class="keyword">switch</span> t.status</span><br><span class="line">      <span class="keyword">case</span> JUST_CREATED:</span><br><span class="line">        print (<span class="string">&quot;JUST_CREATED&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> READY:</span><br><span class="line">        print (<span class="string">&quot;READY&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> RUNNING:</span><br><span class="line">        print (<span class="string">&quot;RUNNING&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> BLOCKED:</span><br><span class="line">        print (<span class="string">&quot;BLOCKED&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> UNUSED:</span><br><span class="line">        print (<span class="string">&quot;UNUSED&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        FatalError (<span class="string">&quot;Bad status in Thread&quot;</span>)</span><br><span class="line">    endSwitch</span><br><span class="line">    <span class="title function_">print</span> <span class="params">(<span class="string">&quot;    (addr of Thread object: &quot;</span>)</span></span><br><span class="line">    <span class="title function_">printHex</span> <span class="params">(t asInteger)</span></span><br><span class="line">    <span class="title function_">print</span> <span class="params">(<span class="string">&quot;)&quot;</span>)</span></span><br><span class="line">    <span class="title function_">nl</span> <span class="params">()</span></span><br><span class="line">    -- t.<span class="title function_">Print</span> <span class="params">()</span></span><br><span class="line">    oldStatus = SetInterruptsTo (oldStatus)</span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>首先禁用中断SetInterruptsTo(DISABLED),避免打印过程中线程被切换。</li>
<li>打印线程的名称。</li>
<li>打印线程的状态:JUST_CREATED、READY、RUNNING、BLOCKED、UNUSED。</li>
<li>打印线程对象的地址,用于区分不同线程。</li>
<li>恢复之前的中断状态。</li>
</ul>
<p>通过打印关键的线程信息,可以方便调试和跟踪线程的状态。禁用中断用于保证打印过程的一致性,不会因为线程切换而导致数据混乱。</p>
<br>
<h2 id="311-thread类封装了每个线程的信息和相关操作"><a class="markdownIt-Anchor" href="#311-thread类封装了每个线程的信息和相关操作"></a> 3.11 Thread类:封装了每个线程的信息和相关操作</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------  Thread  ---------------------------------</span><br><span class="line"></span><br><span class="line">  behavior Thread</span><br><span class="line"></span><br><span class="line">      ----------  Thread . Init  ----------</span><br><span class="line"></span><br><span class="line">      method <span class="title function_">Init</span> <span class="params">(n: String)</span></span><br><span class="line">        --</span><br><span class="line">        -- Initialize this Thread object, but <span class="keyword">do</span> not schedule it <span class="keyword">for</span></span><br><span class="line">        -- execution yet.</span><br><span class="line">        --</span><br><span class="line">          name = n</span><br><span class="line">          status = JUST_CREATED</span><br><span class="line">          -- The next line initializes the systemStack <span class="built_in">array</span>, without filling it in.</span><br><span class="line">          *((&amp; systemStack) asPtrTo <span class="type">int</span>) = SYSTEM_STACK_SIZE</span><br><span class="line">          systemStack [<span class="number">0</span>] = STACK_SENTINEL</span><br><span class="line">          systemStack [SYSTEM_STACK_SIZE<span class="number">-1</span>] = STACK_SENTINEL</span><br><span class="line">          stackTop = &amp; (systemStack[SYSTEM_STACK_SIZE<span class="number">-1</span>])</span><br><span class="line">          regs = new <span class="built_in">array</span> of <span class="type">int</span> &#123; <span class="number">13</span> of <span class="number">0</span> &#125;</span><br><span class="line">        endMethod</span><br><span class="line"></span><br><span class="line">      ----------  Thread . Fork  ----------</span><br><span class="line"></span><br><span class="line">      method Fork (fun: ptr to function (<span class="type">int</span>), arg: <span class="type">int</span>)</span><br><span class="line">        --</span><br><span class="line">        -- This method will schedule this thread <span class="keyword">for</span> execution; in other words</span><br><span class="line">        -- it will make it ready to run by adding it to the <span class="string">&quot;ready queue.&quot;</span>  This</span><br><span class="line">        -- method is passed a function and a single integer argument.  When the</span><br><span class="line">        -- thread runs, the thread will execute this function on that argument</span><br><span class="line">        -- and then termiante.  This method will <span class="keyword">return</span> after scheduling this</span><br><span class="line">        -- thread.</span><br><span class="line">        --</span><br><span class="line">          var</span><br><span class="line">            oldIntStat, junk: <span class="type">int</span></span><br><span class="line">          oldIntStat = SetInterruptsTo (DISABLED)</span><br><span class="line">          -- print (<span class="string">&quot;Forking thread...\n&quot;</span>)</span><br><span class="line">          initialFunction = fun</span><br><span class="line">          initialArgument = arg</span><br><span class="line">          stackTop = stackTop - <span class="number">4</span></span><br><span class="line">          *(stackTop asPtrTo <span class="type">int</span>) = ThreadStartUp asInteger</span><br><span class="line">          status = READY</span><br><span class="line">          readyList.AddToEnd (self)</span><br><span class="line">          junk = SetInterruptsTo (oldIntStat)</span><br><span class="line">        endMethod</span><br><span class="line"></span><br><span class="line">      ----------  Thread . Yield  ----------</span><br><span class="line"></span><br><span class="line">      method Yield ()</span><br><span class="line">        --</span><br><span class="line">        -- This method should only be invoked on the current thread.  The</span><br><span class="line">        -- current thread may yield the processor to other threads by</span><br><span class="line">        -- executing:</span><br><span class="line">        --       currentThread.Yield ()</span><br><span class="line">        -- This method may be invoked with or without interrupts enabled.</span><br><span class="line">        -- Upon <span class="keyword">return</span>, the interrupts will be in the same state; however</span><br><span class="line">        -- since other threads are given a chance to run and they may allow</span><br><span class="line">        -- interrupts, interrupts handlers may have been invoked before</span><br><span class="line">        -- this method returns.</span><br><span class="line">        --</span><br><span class="line">          var</span><br><span class="line">            nextTh: ptr to Thread</span><br><span class="line">            oldIntStat, junk: <span class="type">int</span></span><br><span class="line">          -- ASSERT:</span><br><span class="line">              <span class="keyword">if</span> self != currentThread</span><br><span class="line">                FatalError (<span class="string">&quot;In Yield, self != currentThread&quot;</span>)</span><br><span class="line">              endIf</span><br><span class="line">          oldIntStat = SetInterruptsTo (DISABLED)</span><br><span class="line">          -- print (<span class="string">&quot;Yielding &quot;</span>)</span><br><span class="line">          -- print (name)</span><br><span class="line">          -- print (<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">          nextTh = readyList.Remove ()</span><br><span class="line">          <span class="keyword">if</span> nextTh</span><br><span class="line">            -- print (<span class="string">&quot;About to run &quot;</span>)</span><br><span class="line">            -- print (nextTh.name)</span><br><span class="line">            -- print (<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> status == BLOCKED</span><br><span class="line">              FatalError (<span class="string">&quot;Status of current thread should be READY or RUNNING&quot;</span>)</span><br><span class="line">            endIf</span><br><span class="line">            status = READY</span><br><span class="line">            readyList.AddToEnd (self)</span><br><span class="line">            Run (nextTh)</span><br><span class="line">          endIf</span><br><span class="line">          junk = SetInterruptsTo (oldIntStat)</span><br><span class="line">        endMethod</span><br><span class="line"></span><br><span class="line">      ----------  Thread . Sleep  ----------</span><br><span class="line"></span><br><span class="line">      method Sleep ()</span><br><span class="line">        --</span><br><span class="line">        -- This method should only be invoked on the current thread.  It</span><br><span class="line">        -- will <span class="built_in">set</span> the status of the current thread to BLCOKED and will</span><br><span class="line">        -- will <span class="keyword">switch</span> to executing another thread.  It is assumed that</span><br><span class="line">        --     (<span class="number">1</span>) Interrupts are disabled before calling this routine, and</span><br><span class="line">        --     (<span class="number">2</span>) The current thread has been placed on some other wait</span><br><span class="line">        --         <span class="built_in">list</span> (e.g., <span class="keyword">for</span> a Semaphore) or <span class="keyword">else</span> the thread will</span><br><span class="line">        --         never get scheduled again.</span><br><span class="line">        --</span><br><span class="line">          var nextTh: ptr to Thread</span><br><span class="line">          -- ASSERT:</span><br><span class="line">              <span class="keyword">if</span> currentInterruptStatus != DISABLED</span><br><span class="line">                FatalError (<span class="string">&quot;In Sleep, currentInterruptStatus != DISABLED&quot;</span>)</span><br><span class="line">              endIf</span><br><span class="line">          -- ASSERT:</span><br><span class="line">              <span class="keyword">if</span> self != currentThread</span><br><span class="line">                FatalError (<span class="string">&quot;In Sleep, self != currentThread&quot;</span>)</span><br><span class="line">              endIf</span><br><span class="line">          -- print (<span class="string">&quot;Sleeping &quot;</span>)</span><br><span class="line">          -- print (name)</span><br><span class="line">          -- print (<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">          status = BLOCKED</span><br><span class="line">          nextTh = readyList.Remove ()</span><br><span class="line">          <span class="keyword">if</span> nextTh == null</span><br><span class="line">            FatalError (<span class="string">&quot;Ready list should always contain the idle thread&quot;</span>)</span><br><span class="line">          endIf</span><br><span class="line">          Run (nextTh)</span><br><span class="line">        endMethod</span><br><span class="line"></span><br><span class="line">      ----------  Thread . CheckOverflow  ----------</span><br><span class="line"></span><br><span class="line">      method CheckOverflow ()</span><br><span class="line">        --</span><br><span class="line">        -- This method checks to see <span class="keyword">if</span> this thread has overflowed its</span><br><span class="line">        -- pre-alloted <span class="built_in">stack</span> space.  WARNING: the approach taken here is only</span><br><span class="line">        -- guaranteed to work <span class="string">&quot;with high probability&quot;</span>.</span><br><span class="line">        --</span><br><span class="line">          <span class="keyword">if</span> systemStack[<span class="number">0</span>] != STACK_SENTINEL</span><br><span class="line">            FatalError (<span class="string">&quot;System stack overflow detected!&quot;</span>)</span><br><span class="line">          elseIf systemStack[SYSTEM_STACK_SIZE<span class="number">-1</span>] != STACK_SENTINEL</span><br><span class="line">            FatalError (<span class="string">&quot;System stack underflow detected!&quot;</span>)</span><br><span class="line">          endIf</span><br><span class="line">        endMethod</span><br><span class="line"></span><br><span class="line">      ----------  Thread . Print  ----------</span><br><span class="line"></span><br><span class="line">      method Print ()</span><br><span class="line">        --</span><br><span class="line">        -- Print this object.</span><br><span class="line">        --</span><br><span class="line">          var i: <span class="type">int</span></span><br><span class="line">              oldStatus: <span class="type">int</span></span><br><span class="line">          oldStatus = SetInterruptsTo (DISABLED)</span><br><span class="line">          print (<span class="string">&quot;  Thread \&quot;&quot;</span>)</span><br><span class="line">          print (name)</span><br><span class="line">          print (<span class="string">&quot;\&quot;    (addr of Thread object: &quot;</span>)</span><br><span class="line">          printHex (self asInteger)</span><br><span class="line">          print (<span class="string">&quot;)\n&quot;</span>)</span><br><span class="line">          print (<span class="string">&quot;    machine state:\n&quot;</span>)</span><br><span class="line">          <span class="keyword">for</span> i = <span class="number">0</span> to <span class="number">12</span></span><br><span class="line">            print (<span class="string">&quot;      r&quot;</span>)</span><br><span class="line">            printInt (i+<span class="number">2</span>)</span><br><span class="line">            print (<span class="string">&quot;: &quot;</span>)</span><br><span class="line">            printHex (regs[i])</span><br><span class="line">            print (<span class="string">&quot;   &quot;</span>)</span><br><span class="line">            printInt (regs[i])</span><br><span class="line">            print (<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">          endFor</span><br><span class="line">          printHexVar (<span class="string">&quot;    stackTop&quot;</span>, stackTop asInteger)</span><br><span class="line">          printHexVar (<span class="string">&quot;    stack starting addr&quot;</span>, (&amp; systemStack[<span class="number">0</span>]) asInteger)</span><br><span class="line">          <span class="keyword">switch</span> status</span><br><span class="line">            <span class="keyword">case</span> JUST_CREATED:</span><br><span class="line">              print (<span class="string">&quot;    status = JUST_CREATED\n&quot;</span>)</span><br><span class="line">              <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> READY:</span><br><span class="line">              print (<span class="string">&quot;    status = READY\n&quot;</span>)</span><br><span class="line">              <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> RUNNING:</span><br><span class="line">              print (<span class="string">&quot;    status = RUNNING\n&quot;</span>)</span><br><span class="line">              <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> BLOCKED:</span><br><span class="line">              print (<span class="string">&quot;    status = BLOCKED\n&quot;</span>)</span><br><span class="line">              <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> UNUSED:</span><br><span class="line">              print (<span class="string">&quot;    status = UNUSED\n&quot;</span>)</span><br><span class="line">              <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">              FatalError (<span class="string">&quot;Bad status in Thread&quot;</span>)</span><br><span class="line">          endSwitch</span><br><span class="line">          oldStatus = SetInterruptsTo (oldStatus)</span><br><span class="line">      endMethod</span><br><span class="line"></span><br><span class="line">  endBehavior</span><br></pre></td></tr></table></figure>
<ul>
<li>Init方法用于初始化Thread对象,设置名字、状态等属性。</li>
<li>Fork方法用于启动一个线程,传入线程函数和参数,放入ready队列。</li>
<li>Yield方法在当前线程里调用,将CPU时间片让给其它线程。</li>
<li>Sleep方法使当前线程睡眠/阻塞,调度其它线程运行。</li>
<li>CheckOverflow检查栈空间是否溢出。</li>
<li>Print打印线程详细信息,用于调试</li>
</ul>
<p>关键是通过操作每个Thread对象的状态,配合scheduler的调度逻辑,实现了线程状态的转换和调度机制</p>
<br>
<h2 id="4-switchs"><a class="markdownIt-Anchor" href="#4-switchs"></a> 4.  <code>Switch.s</code></h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">! BLITZ OS - Switch.s</span><br><span class="line">!</span><br><span class="line">! Harry Porter  -  12/07/03</span><br><span class="line">!                  03/24/09</span><br><span class="line">!</span><br><span class="line">! The following functions are implemented in this file:</span><br><span class="line">!</span><br><span class="line">	.export	Switch</span><br><span class="line">	.export	ThreadStartUp</span><br><span class="line">!</span><br><span class="line">! The following functions are imported:</span><br><span class="line">!</span><br><span class="line">	.import	_P_Thread_ThreadStartMain</span><br><span class="line">	.import	_P_Thread_ThreadFinish</span><br><span class="line">!</span><br><span class="line">	.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">! </span><br><span class="line">! ===============  ThreadStartUp  ===============</span><br><span class="line">! </span><br><span class="line">! external ThreadStartUp ()</span><br><span class="line">!</span><br><span class="line">! This routine is where each Thread begins execution.  The Fork function</span><br><span class="line">! will place the starting address of this routine into the Thread object</span><br><span class="line">! so that Switch will &quot;return&quot; to this address, thereby making a jump to</span><br><span class="line">! the first instruction of this routine.  This routine will initialize</span><br><span class="line">! all registers needed by high-level KPL code (namely r12 &amp; r14) and will</span><br><span class="line">! then call the KPL function &quot;ThreadStartMain&quot;.  ThreadStartMain will invoke</span><br><span class="line">! the &quot;main&quot; function of the thread. ThreadStartMain  will never return.</span><br><span class="line">! </span><br><span class="line">ThreadStartUp:</span><br><span class="line">		mov	r0,r14				! Clear the FP register</span><br><span class="line">		mov	r0,r12				! Clear the Catch Stack pointer</span><br><span class="line">		call	_P_Thread_ThreadStartMain	! Call ThreadStartMain</span><br><span class="line">ThreadHang:	debug					! Should never reach this point</span><br><span class="line">		jmp	ThreadHang			! .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">! </span><br><span class="line">! ===============  Switch  ===============</span><br><span class="line">! </span><br><span class="line">! external Switch (prevThread, nextThread: ptr to Thread)</span><br><span class="line">!</span><br><span class="line">! This routine is passed ptrs to 2 Thread objects.  Each Thread object</span><br><span class="line">! contains a place to store the state of the machine.  This includes:</span><br><span class="line">!    r2-r14</span><br><span class="line">!    stackTop (r15)</span><br><span class="line">! This routine switches the state from one thread to the next and returns.</span><br><span class="line">! Of course it will be returning to a different invocation, since the thread</span><br><span class="line">! will have been switched.</span><br><span class="line">!</span><br><span class="line">! This routine trashes r1.</span><br><span class="line">! </span><br><span class="line">Switch:</span><br><span class="line">		load	[r15+4],r1		! Move the prevThread into r1</span><br><span class="line">		add	r1,16,r1		! Make r1 point to r1.regs</span><br><span class="line">		store	r2,[r1+0]		! Save r2..r14 in r1.regs</span><br><span class="line">		store	r3,[r1+4]		! .</span><br><span class="line">		store	r4,[r1+8]		! .</span><br><span class="line">		store	r5,[r1+12]		! .</span><br><span class="line">		store	r6,[r1+16]		! .</span><br><span class="line">		store	r7,[r1+20]		! .</span><br><span class="line">		store	r8,[r1+24]		! .</span><br><span class="line">		store	r9,[r1+28]		! .</span><br><span class="line">		store	r10,[r1+32]		! .</span><br><span class="line">		store	r11,[r1+36]		! .</span><br><span class="line">		store	r12,[r1+40]		! .</span><br><span class="line">		store	r13,[r1+44]		! .</span><br><span class="line">		store	r14,[r1+48]		! .</span><br><span class="line">		store	r15,[r1+52]		! Save r15 in r1.stackTop</span><br><span class="line"></span><br><span class="line">		load	[r15+8],r1		! Move the nextThread into r1</span><br><span class="line">		add	r1,16,r1		! Make r1 point to r1.regs</span><br><span class="line">		load	[r1+0],r2		! Restore r2..r14 from r1.regs</span><br><span class="line">		load	[r1+4],r3		! .</span><br><span class="line">		load	[r1+8],r4		! .</span><br><span class="line">		load	[r1+12],r5		! .</span><br><span class="line">		load	[r1+16],r6		! .</span><br><span class="line">		load	[r1+20],r7		! .</span><br><span class="line">		load	[r1+24],r8		! .</span><br><span class="line">		load	[r1+28],r9		! .</span><br><span class="line">		load	[r1+32],r10		! .</span><br><span class="line">		load	[r1+36],r11		! .</span><br><span class="line">		load	[r1+40],r12		! .</span><br><span class="line">		load	[r1+44],r13		! .</span><br><span class="line">		load	[r1+48],r14		! .</span><br><span class="line">		load	[r1+52],r15		! Restore r15 from r1.stackTop</span><br><span class="line">		ret</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ThreadStartUp</strong>: 每个线程开始执行的入口函数。它会初始化线程所需的寄存器(r12、r14),然后调用 ThreadStartMain 函数,在那里会调用线程的 main 函数。<br />
在线程开始时被调用,它清零了一些寄存器,然后调用 ThreadStartMain 函数启动线程的主要逻辑。</li>
<li><strong>Switch</strong>: 线程切换函数。它接受当前线程和下一个线程的指针作为参数。通过保存和恢复寄存器的值(r2-r15)来在两个线程的上下文之间切换。先把当前线程(prevThread)的寄存器状态保存到它的内存空间,然后加载下一个线程(nextThread)的寄存器状态,实现了切换。</li>
<li>寄存器状态保存在每个线程对象的 regs 字段中。</li>
<li>r15 寄存器也保存到 stackTop 字段,它表示线程的堆栈指针。</li>
</ul>
<br>
<h2 id="5listc"><a class="markdownIt-Anchor" href="#5listc"></a> 5.<code>List.c</code></h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">code List</span><br><span class="line"></span><br><span class="line">  -- Harry Porter  --  December <span class="number">4</span>, <span class="number">2003</span></span><br><span class="line">                   --  December <span class="number">11</span>, <span class="number">2003</span>  -- Modified <span class="keyword">for</span> Listables</span><br><span class="line"></span><br><span class="line">  behavior List</span><br><span class="line"></span><br><span class="line">    method <span class="title function_">AddToFront</span> <span class="params">(p: ptr to T)</span></span><br><span class="line">      --</span><br><span class="line">      -- This method adds an item to the front of the <span class="built_in">list</span>.  This is the</span><br><span class="line">      -- end from which the &quot;Remove&quot; method will retrieve elements.</span><br><span class="line">      --</span><br><span class="line">      -- NOTE: This method assumes the object is not already on any lists.</span><br><span class="line">      --</span><br><span class="line">        <span class="keyword">if</span> self.<span class="title function_">IsEmpty</span> <span class="params">()</span></span><br><span class="line">          first = p</span><br><span class="line">          last = p</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          p.next = first</span><br><span class="line">          first = p</span><br><span class="line">        endIf</span><br><span class="line">      endMethod</span><br><span class="line"></span><br><span class="line">    method AddToEnd (p: ptr to T)</span><br><span class="line">      --</span><br><span class="line">      -- This method adds an item to the tail of the <span class="built_in">list</span>.  Using <span class="string">&quot;AddToEnd&quot;</span></span><br><span class="line">      -- and <span class="string">&quot;Remove&quot;</span> will achieve a FIFO <span class="built_in">queue</span>.</span><br><span class="line">      --</span><br><span class="line">      -- NOTE: This method assumes the object is not already on any lists.</span><br><span class="line">      --</span><br><span class="line">        <span class="keyword">if</span> self.IsEmpty ()</span><br><span class="line">          first = p</span><br><span class="line">          last = p</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          last.next = p</span><br><span class="line">          last = p</span><br><span class="line">        endIf</span><br><span class="line">      endMethod</span><br><span class="line"></span><br><span class="line">    method Remove () returns ptr to T</span><br><span class="line">      --</span><br><span class="line">      -- This method removes the item at the front of the <span class="built_in">list</span> and</span><br><span class="line">      -- returns a ptr to it.  If the <span class="built_in">list</span> is empty, it returns null.</span><br><span class="line">      --</span><br><span class="line">        var item: ptr to T = first</span><br><span class="line">        <span class="keyword">if</span> first == null</span><br><span class="line">          <span class="keyword">return</span> null</span><br><span class="line">        elseIf first == last</span><br><span class="line">          first = null</span><br><span class="line">          last = null</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          first = first.next asPtrTo T</span><br><span class="line">        endIf</span><br><span class="line">        item.next = null</span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line">      endMethod</span><br><span class="line"></span><br><span class="line">    method IsEmpty () returns <span class="type">bool</span></span><br><span class="line">      --</span><br><span class="line">      -- Return <span class="literal">true</span> iff the <span class="built_in">list</span> is empty.</span><br><span class="line">      --</span><br><span class="line">        <span class="keyword">if</span> first</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        endIf</span><br><span class="line">      endMethod</span><br><span class="line"></span><br><span class="line">    method ApplyToEach (f: ptr to function (ptr to T))</span><br><span class="line">      --</span><br><span class="line">      -- This method is passed a function which can be applied to a</span><br><span class="line">      -- <span class="built_in">list</span> element.  This method applies this function (invokes the</span><br><span class="line">      -- function) on every element in the <span class="built_in">list</span>, in order.</span><br><span class="line">      --</span><br><span class="line">        var p: ptr to T</span><br><span class="line">        <span class="keyword">for</span> (p = first; p; p = p.next asPtrTo T)</span><br><span class="line">          f (p)</span><br><span class="line">        endFor</span><br><span class="line">      endMethod</span><br><span class="line"></span><br><span class="line">    method SortedInsert (p: ptr to T, k: <span class="type">int</span>)</span><br><span class="line">      --</span><br><span class="line">      -- This method assumes that the <span class="built_in">list</span> is ordered by key value.</span><br><span class="line">      -- It inserts the element <span class="string">&quot;p&quot;</span> into the proper place, using</span><br><span class="line">      -- a key of <span class="string">&quot;k&quot;</span>.  This method does a linear walk of the <span class="built_in">list</span></span><br><span class="line">      -- to determine where to add the element.</span><br><span class="line">      --</span><br><span class="line">      -- NOTE: This method assumes the object is not already on any lists.</span><br><span class="line">      --</span><br><span class="line">        var q: ptr to Listable</span><br><span class="line">        p.key = k</span><br><span class="line">        <span class="keyword">if</span> self.IsEmpty ()        -- If the <span class="built_in">list</span> is empty...</span><br><span class="line">          first = p               --    create a singleton <span class="built_in">list</span>.</span><br><span class="line">          last = p</span><br><span class="line">        elseIf k &lt; first.key      -- If it should go before the first...</span><br><span class="line">          p.next = first          --    add element to front of <span class="built_in">list</span>.</span><br><span class="line">          first = p</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="keyword">for</span> (q = first; q.next; q = q.next)</span><br><span class="line">            <span class="keyword">if</span> k &lt; q.next.key     -- If it should go after element q...</span><br><span class="line">              p.next = q.next     --    add element after q.</span><br><span class="line">              q.next = p</span><br><span class="line">              <span class="keyword">return</span></span><br><span class="line">            endIf</span><br><span class="line">          endFor                  -- If we hit the end...</span><br><span class="line">          last.next = p           --    add element to end of <span class="built_in">list</span></span><br><span class="line">          last = p</span><br><span class="line">        endIf</span><br><span class="line">      endMethod</span><br><span class="line"></span><br><span class="line">    method SortedRemove (whereToStoreItsKey: ptr to <span class="type">int</span>) returns ptr to T</span><br><span class="line">      --</span><br><span class="line">      -- This method removes the item at the front of the <span class="built_in">list</span> and</span><br><span class="line">      -- returns a ptr to it.  If the <span class="built_in">list</span> is empty, it returns null.</span><br><span class="line">      -- This method is passed <span class="string">&quot;whereToStoreItsKey&quot;</span>, a ptr to an integer</span><br><span class="line">      -- variable (which may be null).  This method will store the key</span><br><span class="line">      -- that this element had in this integer variable, unless the pointer</span><br><span class="line">      -- was null.</span><br><span class="line">      --</span><br><span class="line">        var item: ptr to T = first</span><br><span class="line">        <span class="keyword">if</span> self.IsEmpty ()</span><br><span class="line">          <span class="keyword">return</span> null</span><br><span class="line">        endIf</span><br><span class="line">        item = first</span><br><span class="line">        <span class="keyword">if</span> first == last</span><br><span class="line">          first = null</span><br><span class="line">          last = null</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          first = first.next asPtrTo T</span><br><span class="line">        endIf</span><br><span class="line">        <span class="keyword">if</span> whereToStoreItsKey != null</span><br><span class="line">          * whereToStoreItsKey = item.key</span><br><span class="line">        endIf</span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line">      endMethod</span><br><span class="line"></span><br><span class="line">  endBehavior</span><br><span class="line"></span><br><span class="line">endCode</span><br></pre></td></tr></table></figure>
<p>链表是一种数据结构，由一系列的节点（node）组成，每个节点包含一个数据元素和一个指向下一个节点的指针。链表可以很容易地插入和删除元素。</p>
<ul>
<li><strong>注释</strong>：代码开始处有一些注释，包含了作者的名字和日期。注释有助于其他开发者理解代码的背景和目的。</li>
<li><strong>behavior List</strong>：定义了一个名为List的行为（或类）。这可能是某种特定编程语言中的类定义。</li>
<li><strong>method AddToFront (p: ptr to T)</strong>：这是一个方法，它将一个元素添加到链表的前面。如果链表为空，它会创建一个只有这个元素的链表。如果链表不为空，它会将此元素添加到链表的开始处。</li>
<li><strong>method AddToEnd (p: ptr to T)</strong>：这个方法将一个元素添加到链表的末尾。与AddToFront类似，它处理链表为空和不为空的情况。</li>
<li><strong>method Remove () returns ptr to T</strong>：这个方法从链表的前面移除一个元素并返回它。如果链表为空，它返回null。</li>
<li><strong>method IsEmpty () returns bool</strong>：这个方法检查链表是否为空。如果链表的第一个元素存在，它返回false，否则返回true。</li>
<li><strong>method ApplyToEach (f: ptr to function (ptr to T))</strong>：这个方法接受一个函数作为参数，并将这个函数应用于链表中的每个元素。</li>
<li><strong>method SortedInsert (p: ptr to T, k: int)</strong>：这个方法将一个元素插入到已排序的链表中。它使用线性搜索找到插入点，并将元素插入到适当的位置。</li>
<li><strong>method SortedRemove (whereToStoreItsKey: ptr to int) returns ptr to T</strong>：这个方法从已排序的链表中移除一个元素，并返回它。它还接受一个指向整数的指针，并将移除的元素的键存储在这个整数中。</li>
</ul>
<br>
<h2 id="6mainc"><a class="markdownIt-Anchor" href="#6mainc"></a> 6.<code>Main.c</code></h2>
<p>This package contains the following:</p>
<ul>
<li>SimpleThreadExample</li>
<li>MoreThreadExamples</li>
<li>ProducerConsumer</li>
<li>TestMutex</li>
<li>Dining Philospohers</li>
</ul>
<br>
<h2 id="61-synchtest代码的入口函数"><a class="markdownIt-Anchor" href="#61-synchtest代码的入口函数"></a> 6.1 SynchTest:代码的入口函数</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">main</span> <span class="params">()</span></span><br><span class="line">    <span class="title function_">print</span> <span class="params">(<span class="string">&quot;Example Thread-based Programs...\n&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">InitializeScheduler</span> <span class="params">()</span></span><br><span class="line"></span><br><span class="line">    -----  Uncomment any one of the following to perform the desired test  -----</span><br><span class="line"></span><br><span class="line">    <span class="title function_">SimpleThreadExample</span> <span class="params">()</span></span><br><span class="line">    -- <span class="title function_">MoreThreadExamples</span> <span class="params">()</span></span><br><span class="line">    -- <span class="title function_">TestMutex</span> <span class="params">()</span></span><br><span class="line">    -- <span class="title function_">ProducerConsumer</span> <span class="params">()</span></span><br><span class="line">    -- <span class="title function_">DiningPhilosophers</span> <span class="params">()</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">ThreadFinish</span> <span class="params">()</span></span><br><span class="line"></span><br><span class="line">  endFunction</span><br></pre></td></tr></table></figure>
<br>
<p>例子函数：</p>
<ul>
<li>SimpleThreadExample()：两个简单线程的示例</li>
<li>MoreThreadExamples()：创建多个线程的示例</li>
<li>TestMutex()：测试互斥锁的示例</li>
<li>ProducerConsumer()：生产者-消费者问题的示例</li>
<li>DiningPhilosophers()：哲学家就餐问题的示例</li>
</ul>
<p>通过解除不同例子函数的注释,可以选择运行不同的线程同步案例。最后它调用ThreadFinish()来正确结束所有的线程。</p>
<Br>
<h2 id="62-simplethreadexample两个线程交替运行的示例"><a class="markdownIt-Anchor" href="#62-simplethreadexample两个线程交替运行的示例"></a> 6.2 SimpleThreadExample:两个线程交替运行的示例</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------  SimpleThreadExample  ---------------------------------</span><br><span class="line"></span><br><span class="line">  var aThread: Thread     -- Don<span class="number">&#x27;</span>t put Thread objects on the <span class="built_in">stack</span>, since the</span><br><span class="line">                          -- routine that contains them may <span class="keyword">return</span>!</span><br><span class="line"></span><br><span class="line">  function SimpleThreadExample ()</span><br><span class="line">    -- This code illustrates the basics of thread usage.</span><br><span class="line">    --</span><br><span class="line">    -- This code uses <span class="number">2</span> threads.  Each thread loops a few times.</span><br><span class="line">    -- Each loop iteration prints a message and executes a <span class="string">&quot;Yield&quot;</span>.</span><br><span class="line">    -- This code illustrates the following operations:</span><br><span class="line">    --     Thread creation</span><br><span class="line">    --     Fork</span><br><span class="line">    --     Yield</span><br><span class="line">    --     Thread termination</span><br><span class="line">    -- This code creates only one new thread; the <span class="title function_">currrent</span> <span class="params">(<span class="string">&quot;main&quot;</span>)</span> thread, which</span><br><span class="line">    -- already exists, is the other thread.  Both the main thread and the newly</span><br><span class="line">    -- created thread will call function &quot;SimpleThreadFunction&quot; to perform the looping.</span><br><span class="line">    --</span><br><span class="line">    -- Notice that timer interrupts will also cause &quot;Yields&quot; to be inserted at</span><br><span class="line">    -- unpredictable places.  Thus, the threads will not simply alternate.</span><br><span class="line">    --</span><br><span class="line">    -- Things to experiment with:</span><br><span class="line">    --    In <span class="title function_">TimerInterruptHandler</span> <span class="params">(in Thread.c)</span>, uncomment &quot;<span class="title function_">print</span> <span class="params">(<span class="string">&#x27;_&#x27;</span>)</span>&quot;.</span><br><span class="line">    --    In <span class="title function_">TimerInterruptHandler</span> <span class="params">(in Thread.c)</span>, comment out the call to</span><br><span class="line">    --            Yield, which will suspend timeslicing.</span><br><span class="line">    --    Edit .<span class="title function_">blitzrc</span> <span class="params">(see <span class="string">&quot;sim&quot;</span> command)</span> and change TIME_SLICE value.</span><br><span class="line">    --    In this function, comment out the call to &quot;Yield&quot;.</span><br><span class="line">    --    </span><br><span class="line"></span><br><span class="line">      <span class="title function_">print</span> <span class="params">(<span class="string">&quot;Simple Thread Example...\n&quot;</span>)</span></span><br><span class="line">      aThread = new Thread</span><br><span class="line">      aThread.Init (<span class="string">&quot;Second-Thread&quot;</span>)   -- Initialize, giving thread a name</span><br><span class="line">      aThread.Fork (SimpleThreadFunction, <span class="number">4</span>)  -- Pass <span class="string">&quot;4&quot;</span> as argument to the thread</span><br><span class="line">      SimpleThreadFunction (<span class="number">7</span>)                -- The main thread will loop <span class="number">7</span> times</span><br><span class="line">    endFunction</span><br><span class="line"></span><br><span class="line">  function SimpleThreadFunction (cnt: <span class="type">int</span>)</span><br><span class="line">    -- This function will loop <span class="string">&quot;cnt&quot;</span> times.  Each iteration will print a</span><br><span class="line">    -- message and execute a <span class="string">&quot;Yield&quot;</span>, which will give the other thread a</span><br><span class="line">    -- chance to run.</span><br><span class="line">      var i: <span class="type">int</span></span><br><span class="line">      <span class="keyword">for</span> i = <span class="number">1</span> to cnt</span><br><span class="line">        print (currentThread.name)</span><br><span class="line">        nl ()</span><br><span class="line">        currentThread.Yield ()</span><br><span class="line">      endFor</span><br><span class="line">      ThreadFinish ()</span><br><span class="line">    endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>创建一个新的线程aThread,并初始化其名字为&quot;Second-Thread&quot;</li>
<li>使用aThread.Fork()启动这个新线程,传入参数4,代表新线程将循环4次</li>
<li>主线程调用SimpleThreadFunction(7),代表主线程将循环7次</li>
<li>SimpleThreadFunction()函数包含一个for循环,每次迭代将打印当前线程的名字,打印换行,并调用currentThread.Yield()让出CPU时间片</li>
<li>这样主线程和新创建的线程就会交替执行,每次执行一段时间后让出CPU执行另一个线程</li>
<li>通过让出时间片的方式实现两个线程的协作交替执行</li>
</ul>
<br>
<h2 id="63-morethreadexamples"><a class="markdownIt-Anchor" href="#63-morethreadexamples"></a> 6.3 MoreThreadExamples</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------  MoreThreadExamples  ---------------------------------</span><br><span class="line"></span><br><span class="line">  var th1, th2, th3, th4, th5, th6: Thread</span><br><span class="line"></span><br><span class="line">  function <span class="title function_">MoreThreadExamples</span> <span class="params">()</span></span><br><span class="line">      var j: <span class="type">int</span></span><br><span class="line">          oldStatus: <span class="type">int</span></span><br><span class="line"></span><br><span class="line">      <span class="title function_">print</span> <span class="params">(<span class="string">&quot;Thread Example...\n&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">      -- Create some thread <span class="title function_">objects</span> <span class="params">(not on the heap)</span>.</span><br><span class="line"></span><br><span class="line">      th1 = new Thread</span><br><span class="line">      th2 = new Thread</span><br><span class="line">      th3 = new Thread</span><br><span class="line">      th4 = new Thread</span><br><span class="line">      th5 = new Thread</span><br><span class="line">      th6 = new Thread</span><br><span class="line"></span><br><span class="line">      -- Initialize them.</span><br><span class="line">      th1.Init (<span class="string">&quot;thread-a&quot;</span>)</span><br><span class="line">      th2.Init (<span class="string">&quot;thread-b&quot;</span>)</span><br><span class="line">      th3.Init (<span class="string">&quot;thread-c&quot;</span>)</span><br><span class="line">      th4.Init (<span class="string">&quot;thread-d&quot;</span>)</span><br><span class="line">      th5.Init (<span class="string">&quot;thread-e&quot;</span>)</span><br><span class="line">      th6.Init (<span class="string">&quot;thread-f&quot;</span>)</span><br><span class="line"></span><br><span class="line">      -- Start all threads running.  Each thread will execute the <span class="string">&quot;foo&quot;</span></span><br><span class="line">      -- function, but each will be passed a different argument. </span><br><span class="line">      th1.Fork (foo, <span class="number">1</span>)</span><br><span class="line">      th2.Fork (foo, <span class="number">2</span>)</span><br><span class="line">      th3.Fork (foo, <span class="number">3</span>)</span><br><span class="line">      th4.Fork (foo, <span class="number">4</span>)</span><br><span class="line">      th5.Fork (foo, <span class="number">5</span>)</span><br><span class="line">      th6.Fork (foo, <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">      -- Print this thread<span class="number">&#x27;</span>s name.  Note that we temporarily disable</span><br><span class="line">      -- interrupts so that all printing will happen together.  Without</span><br><span class="line">      -- this, the other threads might print in the middle, causing a mess.</span><br><span class="line">      oldStatus = SetInterruptsTo (DISABLED)</span><br><span class="line">        print (<span class="string">&quot;\nThe currently running thread is &quot;</span>)</span><br><span class="line">        print (currentThread.name)</span><br><span class="line">        print (<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        PrintReadyList ()</span><br><span class="line">      oldStatus = SetInterruptsTo (oldStatus)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> j = <span class="number">1</span> to <span class="number">10</span></span><br><span class="line">        currentThread.Yield ()</span><br><span class="line">        print (<span class="string">&quot;\n..Main..\n&quot;</span>)</span><br><span class="line">      endFor</span><br><span class="line"></span><br><span class="line">      -- Print the readyList at this point...</span><br><span class="line">      PrintReadyList ()</span><br><span class="line">      currentThread.Print()</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">      -- Put this thread to sleep...</span></span><br><span class="line"><span class="comment">      oldStatus = SetInterruptsTo (DISABLED)</span></span><br><span class="line"><span class="comment">      print (&quot;About to Sleep main thread...\n&quot;)</span></span><br><span class="line"><span class="comment">      currentThread.Sleep ()</span></span><br><span class="line"><span class="comment">      FatalError (&quot;BACK FROM SLEEP !?!?!&quot;)</span></span><br><span class="line"><span class="comment">      -- Execution will never reach this point, since the current thread</span></span><br><span class="line"><span class="comment">      -- was not placed on any list of waiting threads.  Nothing in this</span></span><br><span class="line"><span class="comment">      -- code could ever move this thread back to the ready list.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">      ThreadFinish ()</span><br><span class="line"></span><br><span class="line">    endFunction</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  function foo (i: <span class="type">int</span>)</span><br><span class="line">      var j: <span class="type">int</span></span><br><span class="line"> </span><br><span class="line">      <span class="keyword">for</span> j = <span class="number">1</span> to <span class="number">30</span></span><br><span class="line">        printInt (i)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> j == <span class="number">20</span></span><br><span class="line">          -- Next is an example of aborting all threads and shutting down...</span><br><span class="line">          --   FatalError (<span class="string">&quot;Whoops...(SAMPLE ERROR MESSAGE)&quot;</span>)</span><br><span class="line"></span><br><span class="line">          -- Next is an example of just quietly shutting down...</span><br><span class="line">          --   RuntimeExit ()</span><br><span class="line"></span><br><span class="line">          -- Next is an example of what happens <span class="keyword">if</span> execution errors occur...</span><br><span class="line">          --   i = j / <span class="number">0</span>         -- Generate an error</span><br><span class="line">        endIf</span><br><span class="line"></span><br><span class="line">        -- Call Yield so other threads can run.  This is not necessary,</span><br><span class="line">        -- but it will cause more interleaving of the various threads,</span><br><span class="line">        -- making this program<span class="number">&#x27;</span>s output more interesting.</span><br><span class="line">        currentThread.Yield ()</span><br><span class="line">      endFor</span><br><span class="line">    endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>创建了6个Thread对象th1~th6</li>
<li>使用th[i].Init()给每个线程初始化一个名字</li>
<li>使用th[i].Fork()启动每个线程,都调用同一个函数foo(),但传入不同的参数i</li>
<li>主线程打印自己的名字,打印readyList</li>
<li>主线程循环Yield()让出CPU时间片</li>
<li>打印readyList, 打印主线程信息</li>
<li>foo()函数中每个线程有一个循环,打印参数i,以参数i来区分不同的线程</li>
<li>如果j==20,有一些列的线程终止/退出的示例</li>
<li>每次循环调用Yield()发生线程交替</li>
</ul>
<br>
<p>这个示例演示了:</p>
<ul>
<li>多个线程的创建和启动</li>
<li>传入参数来区分不同的线程</li>
<li>Yield()的用法</li>
<li>线程的退出/终止方法</li>
<li>readyList的数据结构</li>
</ul>
<Br>
<h2 id="64-test-mutex演示了关键部分和互斥"><a class="markdownIt-Anchor" href="#64-test-mutex演示了关键部分和互斥"></a> 6.4 Test Mutex：演示了“关键部分”和“互斥”</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------  Test Mutex  ---------------------------------</span><br><span class="line"></span><br><span class="line">  -- This code illustrates the ideas behind <span class="string">&quot;critical sections&quot;</span> and <span class="string">&quot;mutual</span></span><br><span class="line"><span class="string">  -- exclusion&quot;</span>.  This code creates several threads.  Each thread accesses</span><br><span class="line">  -- some shared <span class="title function_">data</span> <span class="params">(an integer)</span> in a critical section.  A single lock</span><br><span class="line">  -- is used to control access to the shared variable.  Each thread locks</span><br><span class="line">  -- the mutex, computes a <span class="keyword">while</span>, increments the integer, prints the new value,</span><br><span class="line">  -- updates the shared copy, and unlocks the mutex.  Then it does some</span><br><span class="line">  -- non-critical computation and repeats.</span><br><span class="line"></span><br><span class="line">  var</span><br><span class="line">    myLock: Mutex = new Mutex      -- Could also use <span class="string">&quot;Mutex2&quot;</span> instead</span><br><span class="line">    sharedInt: <span class="type">int</span> = <span class="number">0</span></span><br><span class="line">    thArr: <span class="built_in">array</span> [<span class="number">7</span>] of Thread = new <span class="built_in">array</span> of Thread &#123;<span class="number">7</span> of new Thread &#125;</span><br><span class="line"></span><br><span class="line">  function TestMutex ()</span><br><span class="line">      myLock.Init ()</span><br><span class="line"></span><br><span class="line">      print (<span class="string">&quot;\n-- You should see 70 lines, each consecutively numbered. --\n\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">      thArr[<span class="number">0</span>].Init (<span class="string">&quot;LockTester-A&quot;</span>)</span><br><span class="line">      thArr[<span class="number">0</span>].Fork (LockTester, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">      thArr[<span class="number">1</span>].Init (<span class="string">&quot;LockTester-B&quot;</span>)</span><br><span class="line">      thArr[<span class="number">1</span>].Fork (LockTester, <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">      thArr[<span class="number">2</span>].Init (<span class="string">&quot;LockTester-C&quot;</span>)</span><br><span class="line">      thArr[<span class="number">2</span>].Fork (LockTester, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">      thArr[<span class="number">3</span>].Init (<span class="string">&quot;LockTester-D&quot;</span>)</span><br><span class="line">      thArr[<span class="number">3</span>].Fork (LockTester, <span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">      thArr[<span class="number">4</span>].Init (<span class="string">&quot;LockTester-E&quot;</span>)</span><br><span class="line">      thArr[<span class="number">4</span>].Fork (LockTester, <span class="number">300</span>)</span><br><span class="line"></span><br><span class="line">      thArr[<span class="number">5</span>].Init (<span class="string">&quot;LockTester-F&quot;</span>)</span><br><span class="line">      thArr[<span class="number">5</span>].Fork (LockTester, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">      thArr[<span class="number">6</span>].Init (<span class="string">&quot;LockTester-G&quot;</span>)</span><br><span class="line">      thArr[<span class="number">6</span>].Fork (LockTester, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">      ThreadFinish ()</span><br><span class="line">    endFunction</span><br><span class="line"></span><br><span class="line">  function LockTester (waitTime: <span class="type">int</span>)</span><br><span class="line">    -- This function will <span class="keyword">do</span> the following actions, several times in a loop:</span><br><span class="line">    --     Lock the mutex</span><br><span class="line">    --     Get the current value of the <span class="string">&quot;sharedInt&quot;</span> variable</span><br><span class="line">    --     Compute a new value by adding <span class="number">1</span></span><br><span class="line">    --     Wait a <span class="keyword">while</span> (determined by parameter <span class="string">&quot;waitTime&quot;</span>) to simulate</span><br><span class="line">    --        actions done within the critical section</span><br><span class="line">    --     Print the thread<span class="number">&#x27;</span>s name and the new value</span><br><span class="line">    --     Update the <span class="string">&quot;sharedInt&quot;</span> variable</span><br><span class="line">    --     Unlock the mutex</span><br><span class="line">    --     Wait a <span class="keyword">while</span> (determined by parameter <span class="string">&quot;waitTime&quot;</span>) to simulate</span><br><span class="line">    --        actions done outside of the critical section</span><br><span class="line">      var</span><br><span class="line">        i, j, k: <span class="type">int</span></span><br><span class="line">      <span class="keyword">for</span> i = <span class="number">1</span> to <span class="number">10</span></span><br><span class="line"></span><br><span class="line">        -- Enter</span><br><span class="line">        myLock.Lock()</span><br><span class="line"></span><br><span class="line">        -- Critical Section</span><br><span class="line">        j = sharedInt + <span class="number">1</span>                    -- read shared data</span><br><span class="line">        <span class="keyword">for</span> k = <span class="number">1</span> to waitTime                -- <span class="keyword">do</span> some computation</span><br><span class="line">        endFor                               --</span><br><span class="line">        printIntVar (currentThread.name, j)  -- print new data value</span><br><span class="line">        sharedInt = j                        -- update shared data</span><br><span class="line"></span><br><span class="line">        -- Leave</span><br><span class="line">        myLock.Unlock()</span><br><span class="line"></span><br><span class="line">        -- Perform non-critical work</span><br><span class="line">        <span class="keyword">for</span> k = <span class="number">1</span> to waitTime</span><br><span class="line">        endFor</span><br><span class="line"></span><br><span class="line">      endFor</span><br><span class="line">    endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>创建一个Mutex对象myLock用于互斥锁。</li>
<li>定义一个共享整数sharedInt,初始化为0。</li>
<li>创建7个线程对象,存储在数组thArr中。</li>
<li>每个线程调用LockTester函数,传入不同的等待时间。</li>
<li>LockTester函数中有一个循环:
<ul>
<li>锁住互斥锁myLock</li>
<li>读取共享整数到j</li>
<li>做一些计算</li>
<li>打印线程名和新整数值j</li>
<li>更新共享整数为j</li>
<li>解锁互斥锁myLock</li>
<li>做一些非关键计算</li>
</ul>
</li>
<li>这样每个线程就可以互斥地、有序地访问共享数据,实现了互斥</li>
</ul>
<p>该程序通过互斥锁的加锁和解锁,实现了多个线程对共享资源的互斥访问,避免了竞争条件和数据混乱的问题</p>
<br>
<h2 id="65-producerconsumer生产者-消费者模型"><a class="markdownIt-Anchor" href="#65-producerconsumer生产者-消费者模型"></a> 6.5 ProducerConsumer:生产者-消费者模型</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------  ProducerConsumer  ---------------------------------</span><br><span class="line"></span><br><span class="line">  -- This code implements the consumer-producer task.  There are several</span><br><span class="line">  -- <span class="string">&quot;producers&quot;</span>, several <span class="string">&quot;consumers&quot;</span>, and a single shared buffer.</span><br><span class="line">  --</span><br><span class="line">  -- The producers are named <span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>, etc.  Each producer is a thread which</span><br><span class="line">  -- will loop <span class="number">5</span> times.  For each iteration, the producer thread will add its</span><br><span class="line">  -- character to a shared buffer.  For example, <span class="string">&quot;Producer-B&quot;</span> will add <span class="number">5</span> <span class="string">&quot;B&quot;</span>s to</span><br><span class="line">  -- the shared buffer.  Since the <span class="number">5</span> producer threads will run concurrently, the</span><br><span class="line">  -- characters will be added in an unpredictable order.  Regardless of the order,</span><br><span class="line">  -- however, there will be five <span class="string">&quot;A&quot;</span>s, five <span class="string">&quot;B&quot;</span>s, five <span class="string">&quot;C&quot;</span>s, etc.</span><br><span class="line">  --</span><br><span class="line">  -- There are several consumers.  Each consumer is a thread which executes an</span><br><span class="line">  -- inifinite loop.  During each iteration of its loop, a consumer will remove</span><br><span class="line">  -- whatever character is next in the buffer and will print it.</span><br><span class="line">  --</span><br><span class="line">  -- The shared buffer is a FIFO <span class="built_in">queue</span> of characters.  The producers put characters</span><br><span class="line">  -- in one end and the consumers take characters out the other end.  Think of a</span><br><span class="line">  -- section of steel pipe.  The capacity of the buffer is limited to BUFFER_SIZE</span><br><span class="line">  -- characters.</span><br><span class="line">  --</span><br><span class="line">  -- This code illustrates the mechanisms required to synchronize the producers,</span><br><span class="line">  -- consumers, and the shared buffer.  Consumers must wait <span class="keyword">if</span> the buffer is empty.</span><br><span class="line">  -- Producers must wait <span class="keyword">if</span> the buffer is full.  Furthermore, the buffer is a shared</span><br><span class="line">  -- data structure.  (The buffer is implemented as an <span class="built_in">array</span> with pointers to the</span><br><span class="line">  -- next position to add or remove characters.)  No two threads are allowed to</span><br><span class="line">  -- access these pointers simultaneously, or <span class="keyword">else</span> errors may result.</span><br><span class="line">  --</span><br><span class="line">  -- To document what is happening, each producer will print a line when it adds</span><br><span class="line">  -- a character to the buffer.  The line printed will include the buffer contents</span><br><span class="line">  -- along with the name of the poducer.  Also, each time a consumer removes a</span><br><span class="line">  -- character from the buffer, it will print a line, showing the buffer contents</span><br><span class="line">  -- after the removal, along with the name of the consumer thread.  Each line of</span><br><span class="line">  -- output is formated so that you can see the buffer growing and shrinking.  By</span><br><span class="line">  -- reading the output vertically, you can also see what each thread does.</span><br><span class="line">  --</span><br><span class="line">  <span class="type">const</span></span><br><span class="line">    BUFFER_SIZE = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">  var</span><br><span class="line">    buffer: <span class="built_in">array</span> [BUFFER_SIZE] of <span class="type">char</span> = new <span class="built_in">array</span> of <span class="type">char</span> &#123;BUFFER_SIZE of <span class="string">&#x27;?&#x27;</span>&#125;</span><br><span class="line">    bufferSize: <span class="type">int</span> = <span class="number">0</span></span><br><span class="line">    bufferNextIn: <span class="type">int</span> = <span class="number">0</span></span><br><span class="line">    bufferNextOut: <span class="type">int</span> = <span class="number">0</span></span><br><span class="line">    thArray: <span class="built_in">array</span> [<span class="number">8</span>] of Thread = new <span class="built_in">array</span> of Thread &#123; <span class="number">8</span> of new Thread &#125;</span><br><span class="line"></span><br><span class="line">  function ProducerConsumer ()</span><br><span class="line"></span><br><span class="line">      print (<span class="string">&quot;     &quot;</span>)</span><br><span class="line"></span><br><span class="line">      thArray[<span class="number">0</span>].Init (<span class="string">&quot;Consumer-1                               |      &quot;</span>)</span><br><span class="line">      thArray[<span class="number">0</span>].Fork (Consumer, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">      thArray[<span class="number">1</span>].Init (<span class="string">&quot;Consumer-2                               |          &quot;</span>)</span><br><span class="line">      thArray[<span class="number">1</span>].Fork (Consumer, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">      thArray[<span class="number">2</span>].Init (<span class="string">&quot;Consumer-3                               |              &quot;</span>)</span><br><span class="line">      thArray[<span class="number">2</span>].Fork (Consumer, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">      thArray[<span class="number">3</span>].Init (<span class="string">&quot;Producer-A         &quot;</span>)</span><br><span class="line">      thArray[<span class="number">3</span>].Fork (Producer, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">      thArray[<span class="number">4</span>].Init (<span class="string">&quot;Producer-B             &quot;</span>)</span><br><span class="line">      thArray[<span class="number">4</span>].Fork (Producer, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">      thArray[<span class="number">5</span>].Init (<span class="string">&quot;Producer-C                 &quot;</span>)</span><br><span class="line">      thArray[<span class="number">5</span>].Fork (Producer, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">      thArray[<span class="number">6</span>].Init (<span class="string">&quot;Producer-D                     &quot;</span>)</span><br><span class="line">      thArray[<span class="number">6</span>].Fork (Producer, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">      thArray[<span class="number">7</span>].Init (<span class="string">&quot;Producer-E                         &quot;</span>)</span><br><span class="line">      thArray[<span class="number">7</span>].Fork (Producer, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">      ThreadFinish ()</span><br><span class="line">    endFunction</span><br><span class="line"></span><br><span class="line">  function Producer (myId: <span class="type">int</span>)</span><br><span class="line">      var</span><br><span class="line">        i: <span class="type">int</span></span><br><span class="line">        c: <span class="type">char</span> = intToChar (<span class="string">&#x27;A&#x27;</span> + myId - <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">for</span> i = <span class="number">1</span> to <span class="number">5</span></span><br><span class="line">        -- Perform synchroniztion...</span><br><span class="line"></span><br><span class="line">        -- Add c to the buffer</span><br><span class="line">        buffer [bufferNextIn] = c</span><br><span class="line">        bufferNextIn = (bufferNextIn + <span class="number">1</span>) % BUFFER_SIZE</span><br><span class="line">        bufferSize = bufferSize + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        -- Print a line showing the state</span><br><span class="line">        PrintBuffer (c)</span><br><span class="line"></span><br><span class="line">        -- Perform synchronization...</span><br><span class="line"></span><br><span class="line">      endFor</span><br><span class="line">    endFunction</span><br><span class="line"></span><br><span class="line">  function Consumer (myId: <span class="type">int</span>)</span><br><span class="line">      var</span><br><span class="line">        c: <span class="type">char</span></span><br><span class="line">      <span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line">        -- Perform synchroniztion...</span><br><span class="line"></span><br><span class="line">        -- Remove next character from the buffer</span><br><span class="line">        c = buffer [bufferNextOut]</span><br><span class="line">        bufferNextOut = (bufferNextOut + <span class="number">1</span>) % BUFFER_SIZE</span><br><span class="line">        bufferSize = bufferSize - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        -- Print a line showing the state</span><br><span class="line">        PrintBuffer (c)</span><br><span class="line"></span><br><span class="line">        -- Perform synchronization...</span><br><span class="line"></span><br><span class="line">      endWhile</span><br><span class="line">    endFunction</span><br><span class="line"></span><br><span class="line">  function PrintBuffer (c: <span class="type">char</span>)</span><br><span class="line">    --</span><br><span class="line">    -- This method prints the buffer and what we are doing to it.  Each</span><br><span class="line">    -- line should have</span><br><span class="line">    --        &lt;buffer&gt;  &lt;threadname&gt; &lt;character involved&gt;</span><br><span class="line">    -- We want to print the buffer as it was *before* the operation;</span><br><span class="line">    -- however, this method is called *after* the buffer has been modified.</span><br><span class="line">    -- To achieve the right order, we print the operation first, skip to</span><br><span class="line">    -- the next line, and then print the buffer.  Assuming we start by</span><br><span class="line">    -- printing an empty buffer first, and we are willing to end the output</span><br><span class="line">    -- in the middle of a line, this prints things in the desired order.</span><br><span class="line">    --</span><br><span class="line">      var</span><br><span class="line">        i, j: <span class="type">int</span></span><br><span class="line">      -- Print the thread name, which tells what we are doing.</span><br><span class="line">      print (<span class="string">&quot;   &quot;</span>)</span><br><span class="line">      print (currentThread.name)  -- Will include right number of spaces after name</span><br><span class="line">      <span class="title function_">printChar</span> <span class="params">(c)</span></span><br><span class="line">      <span class="title function_">nl</span> <span class="params">()</span></span><br><span class="line">      -- Print the contents of the buffer.</span><br><span class="line">      j = bufferNextOut</span><br><span class="line">      <span class="keyword">for</span> i = <span class="number">1</span> to bufferSize</span><br><span class="line">        printChar (buffer[j])</span><br><span class="line">        j = (j + <span class="number">1</span>) % BUFFER_SIZE</span><br><span class="line">      endFor</span><br><span class="line">      -- Pad out with blanks to make things line up.</span><br><span class="line">      <span class="keyword">for</span> i = <span class="number">1</span> to BUFFER_SIZE-bufferSize</span><br><span class="line">        printChar (<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">      endFor</span><br><span class="line">    endFunction</span><br></pre></td></tr></table></figure>
<ul>
<li>缓冲区(buffer):一个固定大小的队列,用于生产者线程向其中添加字符,消费者线程从中取出字符。</li>
<li>生产者线程(Producer):名称为A、B、C等,每个生产者线程将自己的字符添加到缓冲区,总共添加5次。由于生产者线程是并发运行的,添加的顺序是不确定的。</li>
<li>消费者线程(Consumer):多个消费者线程并发运行,每个消费者线程从缓冲区头部取出一个字符并打印。</li>
<li>同步机制:
<ul>
<li>如果缓冲区满了,生产者线程等待</li>
<li>如果缓冲区空了,消费者线程等待</li>
<li>对缓冲区的访问需要互斥,避免竞争条件</li>
</ul>
</li>
<li>打印输出:生产者在放入一个字符时打印缓冲区状态,消费者在取出一个字符时打印缓冲区状态。通过打印可以清晰地看到缓冲区的变化过程。</li>
</ul>
<p>该程序通过生产者-消费者模型,运用多线程、同步机制与共享缓冲区实现了一个典型的并发控制实例</p>
<Br>
<h2 id="66-dining-philosophers哲学家就餐问题"><a class="markdownIt-Anchor" href="#66-dining-philosophers哲学家就餐问题"></a> 6.6 Dining Philosophers：哲学家就餐问题</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------  Dining Philosophers  ---------------------------------</span><br><span class="line"></span><br><span class="line">  -- This code is an implementation of the Dining Philosophers problem.  Each</span><br><span class="line">  -- philosopher is simulated with a thread.  Each philosopher thinks <span class="keyword">for</span> a <span class="keyword">while</span></span><br><span class="line">  -- and then wants to eat.  Before eating, he must pick up both his forks.</span><br><span class="line">  -- After eating, he <span class="built_in">puts</span> down his forks.  Each fork is shared between</span><br><span class="line">  -- two philosophers and there are <span class="number">5</span> philosophers and <span class="number">5</span> forks arranged in a</span><br><span class="line">  -- circle.</span><br><span class="line">  --</span><br><span class="line">  -- Since the forks are shared, access to them is controlled by a monitor</span><br><span class="line">  -- called <span class="string">&quot;ForkMonitor&quot;</span>.  The monitor is an object with two <span class="string">&quot;entry&quot;</span> methods:</span><br><span class="line">  --     PickupForks (phil)</span><br><span class="line">  --     PutDownForks (phil)</span><br><span class="line">  -- The philsophers are numbered <span class="number">0</span> to <span class="number">4</span> and each of these methods is passed an integer</span><br><span class="line">  -- indicating which philospher wants to <span class="title function_">pickup</span> <span class="params">(or put down)</span> the forks.</span><br><span class="line">  -- The call to &quot;PickUpForks&quot; will wait until both of his forks are</span><br><span class="line">  -- available.  The call to &quot;PutDownForks&quot; will never wait and may also</span><br><span class="line">  -- wake up <span class="title function_">threads</span> <span class="params">(i.e., philosophers)</span> who are waiting.</span><br><span class="line">  --</span><br><span class="line">  -- Each philospher is in exactly one state: HUNGRY, EATING, or THINKING.  Each time</span><br><span class="line">  -- a philosopher&#x27;s state changes, a line of output is printed.  The output is organized</span><br><span class="line">  -- so that each philosopher has column of output with the following code letters:</span><br><span class="line">  --           E    --  eating</span><br><span class="line">  --           .    --  thinking</span><br><span class="line">  --         blank  --  <span class="title function_">hungry</span> <span class="params">(i.e., waiting <span class="keyword">for</span> forks)</span></span><br><span class="line">  -- By reading down a column, you can see the history of a philosopher.</span><br><span class="line">  --</span><br><span class="line">  -- The forks are not modeled explicitly.  A fork is only picked up</span><br><span class="line">  -- by a philospher <span class="keyword">if</span> he can pick up both forks at the same time and begin</span><br><span class="line">  -- eating.  To know whether a fork is available, it is sufficient to simply</span><br><span class="line">  -- look at the status&#x27;s of the two adjacent philosophers.  <span class="params">(Another way to state</span></span><br><span class="line"><span class="params">  -- the problem is to forget about the forks altogether and stipulate that a</span></span><br><span class="line"><span class="params">  -- philosopher may only eat when his two neighbors are not eating.)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">enum</span> HUNGRY, EATING, THINKING</span><br><span class="line">  var</span><br><span class="line">    mon: ForkMonitor</span><br><span class="line">    philospher: <span class="built_in">array</span> [5] of Thread = new <span class="built_in">array</span> of Thread &#123;<span class="number">5</span> of new Thread &#125;</span><br><span class="line"></span><br><span class="line">  function DiningPhilosophers ()</span><br><span class="line"></span><br><span class="line">      print (<span class="string">&quot;Plato\n&quot;</span>)</span><br><span class="line">      print (<span class="string">&quot;    Sartre\n&quot;</span>)</span><br><span class="line">      print (<span class="string">&quot;        Kant\n&quot;</span>)</span><br><span class="line">      print (<span class="string">&quot;            Nietzsche\n&quot;</span>)</span><br><span class="line">      print (<span class="string">&quot;                Aristotle\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">      mon = new ForkMonitor</span><br><span class="line">      mon.Init ()</span><br><span class="line">      mon.PrintAllStatus ()</span><br><span class="line"></span><br><span class="line">      philospher[<span class="number">0</span>].Init (<span class="string">&quot;Plato&quot;</span>)</span><br><span class="line">      philospher[<span class="number">0</span>].Fork (PhilosphizeAndEat, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">      philospher[<span class="number">1</span>].Init (<span class="string">&quot;Sartre&quot;</span>)</span><br><span class="line">      philospher[<span class="number">1</span>].Fork (PhilosphizeAndEat, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">      philospher[<span class="number">2</span>].Init (<span class="string">&quot;Kant&quot;</span>)</span><br><span class="line">      philospher[<span class="number">2</span>].Fork (PhilosphizeAndEat, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">      philospher[<span class="number">3</span>].Init (<span class="string">&quot;Nietzsche&quot;</span>)</span><br><span class="line">      philospher[<span class="number">3</span>].Fork (PhilosphizeAndEat, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">      philospher[<span class="number">4</span>].Init (<span class="string">&quot;Aristotle&quot;</span>)</span><br><span class="line">      philospher[<span class="number">4</span>].Fork (PhilosphizeAndEat, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">     endFunction</span><br><span class="line"></span><br><span class="line">  function PhilosphizeAndEat (p: <span class="type">int</span>)</span><br><span class="line">    -- The parameter <span class="string">&quot;p&quot;</span> identifies which philosopher this is.</span><br><span class="line">    -- In a loop, he will think, acquire his forks, eat, and</span><br><span class="line">    -- put down his forks.</span><br><span class="line">      var</span><br><span class="line">        i: <span class="type">int</span></span><br><span class="line">      <span class="keyword">for</span> i = <span class="number">1</span> to <span class="number">7</span></span><br><span class="line">        -- Now he is thinking</span><br><span class="line">        mon. PickupForks (p)</span><br><span class="line">        -- Now he is eating</span><br><span class="line">        mon. PutDownForks (p)</span><br><span class="line">      endFor</span><br><span class="line">    endFunction</span><br><span class="line"></span><br><span class="line">  class ForkMonitor</span><br><span class="line">    superclass Object</span><br><span class="line">    fields</span><br><span class="line">      status: <span class="built_in">array</span> [<span class="number">5</span>] of <span class="type">int</span>             -- For each philosopher: HUNGRY, EATING, or THINKING</span><br><span class="line">    methods</span><br><span class="line">      Init ()</span><br><span class="line">      PickupForks (p: <span class="type">int</span>)</span><br><span class="line">      PutDownForks (p: <span class="type">int</span>)</span><br><span class="line">      PrintAllStatus ()</span><br><span class="line">  endClass</span><br><span class="line"></span><br><span class="line">  behavior ForkMonitor</span><br><span class="line"></span><br><span class="line">    method Init ()</span><br><span class="line">      -- Initialize so that all philosophers are THINKING.</span><br><span class="line">      -- ...unimplemented...</span><br><span class="line">      endMethod</span><br><span class="line"></span><br><span class="line">    method PickupForks (p: <span class="type">int</span>)</span><br><span class="line">      -- This method is called when philosopher <span class="string">&#x27;p&#x27;</span> is wants to eat.</span><br><span class="line">      -- ...unimplemented...</span><br><span class="line">      endMethod</span><br><span class="line"></span><br><span class="line">    method PutDownForks (p: <span class="type">int</span>)</span><br><span class="line">      -- This method is called when the philosopher <span class="string">&#x27;p&#x27;</span> is done eating.</span><br><span class="line">      -- ...unimplemented...</span><br><span class="line">      endMethod</span><br><span class="line"></span><br><span class="line">    method PrintAllStatus ()</span><br><span class="line">      -- Print a single line showing the status of all philosophers.</span><br><span class="line">      --      <span class="string">&#x27;.&#x27;</span> means thinking</span><br><span class="line">      --      <span class="string">&#x27; &#x27;</span> means hungry</span><br><span class="line">      --      <span class="string">&#x27;E&#x27;</span> means eating</span><br><span class="line">      -- Note that this method is internal to the monitor.  Thus, when</span><br><span class="line">      -- it is called, the monitor lock will already have been acquired</span><br><span class="line">      -- by the thread.  Therefore, this method can never be re-entered,</span><br><span class="line">      -- since only one thread at a time may execute within the monitor.</span><br><span class="line">      -- Consequently, printing is safe.  This method calls the <span class="string">&quot;print&quot;</span></span><br><span class="line">      -- routine several times to print a single line, but these will all</span><br><span class="line">      -- happen without interuption.</span><br><span class="line">        var</span><br><span class="line">          p: <span class="type">int</span></span><br><span class="line">        <span class="keyword">for</span> p = <span class="number">0</span> to <span class="number">4</span></span><br><span class="line">          <span class="keyword">switch</span> status [p]</span><br><span class="line">            <span class="keyword">case</span> HUNGRY:</span><br><span class="line">              print (<span class="string">&quot;    &quot;</span>)</span><br><span class="line">              <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> EATING:</span><br><span class="line">              print (<span class="string">&quot;E   &quot;</span>)</span><br><span class="line">              <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> THINKING:</span><br><span class="line">              print (<span class="string">&quot;.   &quot;</span>)</span><br><span class="line">              <span class="keyword">break</span></span><br><span class="line">          endSwitch</span><br><span class="line">        endFor</span><br><span class="line">        nl ()</span><br><span class="line">      endMethod</span><br><span class="line"></span><br><span class="line">  endBehavior</span><br><span class="line"></span><br><span class="line">endCode</span><br></pre></td></tr></table></figure>
<ul>
<li>哲学家线程:创建5个哲学家线程,每个哲学家线程调用PhilosphizeAndEat函数。</li>
<li>状态:每个哲学家有三种状态:思考(THINKING)、饥饿(HUNGRY)、进餐(EATING)。状态保存在ForkMonitor的status数组中。</li>
<li>筷子:筷子使用ForkMonitor监视器来管理。每个哲学家在进餐前需要调用PickupForks获取两根筷子,吃完后调用PutDownForks释放筷子。</li>
<li>输出:每次哲学家状态改变时,打印一行输出表示所有哲学家的当前状态。</li>
<li>进餐规则:一个哲学家只能在两个邻居都不进餐时pickup两个筷子并进餐,避免死锁。</li>
<li>互斥:ForkMonitor监视器保证了对筷子的互斥访问</li>
</ul>
<p>这个实现运用了多线程、监视器、互斥机制来控制多个线程对共享资源的访问,避免了死锁,很好地解决了这个经典的并发同步问题</p>

            
        </div>
        <footer class="article-footer">
            <a data-url="https://abinzzz.github.io/2023/10/22/OS-p2-code/" data-id="clo0ckoo800007d69f4ym96kl" data-title="OS:p2-code"
               class="article-share-link">分享</a>
            
            
            
            
    <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code/" rel="tag">code</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/p2/" rel="tag">p2</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%93%E4%B8%9A%E7%9F%A5%E8%AF%86/" rel="tag">专业知识</a></li></ul>


        </footer>
    </div>
    
        
    <nav id="article-nav" class="wow fadeInUp">
        
            <div class="article-nav-link-wrap article-nav-link-left">
                
                    <img data-src="https://singyesterday.com/cmn/images/gallery/l/pic_200325_22.jpg" data-sizes="auto" alt="Blitz:question"
                         class="lazyload">
                
                <a href="/2023/10/22/Blitz-question/"></a>
                <div class="article-nav-caption">前一篇</div>
                <h3 class="article-nav-title">
                    
                        Blitz:question
                    
                </h3>
            </div>
        
        
            <div class="article-nav-link-wrap article-nav-link-right">
                
                    <img data-src="https://singyesterday.com/cmn/images/gallery/l/pic_200325_22.jpg" data-sizes="auto" alt="Blitz:An Overview of the BLITZ Computer Hardware"
                         class="lazyload">
                
                <a href="/2023/10/22/Blitz-An-Overview-of-the-BLITZ-Computer-Hardware/"></a>
                <div class="article-nav-caption">后一篇</div>
                <h3 class="article-nav-title">
                    
                        Blitz:An Overview of the BLITZ Computer Hardware
                    
                </h3>
            </div>
        
    </nav>


    
</article>











</section>
                
                    <aside id="sidebar">
    <div class="sidebar-wrap wow fadeInRight">
        <div class="sidebar-author">
            <img data-src="/avatar/avatar.jpg" data-sizes="auto" alt="野中晴" class="lazyload">
            <div class="sidebar-author-name">野中晴</div>
            <div class="sidebar-description">Love is selfish.</div>
        </div>
        <div class="sidebar-state">
            <div class="sidebar-state-article">
                <div>文章</div>
                <div class="sidebar-state-number">194</div>
            </div>
            <div class="sidebar-state-category">
                <div>分类</div>
                <div class="sidebar-state-number">18</div>
            </div>
            <div class="sidebar-state-tag">
                <div>标签</div>
                <div class="sidebar-state-number">254</div>
            </div>
        </div>
        <div class="sidebar-social">
            
                <div class=icon-github>
                    <a href=https://github.com/abinzzz itemprop="url" target="_blank"></a>
                </div>
            
        </div>
        <div class="sidebar-menu">
            
                <div class="sidebar-menu-link-wrap">
                    <a class="sidebar-menu-link-dummy" href="/"></a>
                    <span class="sidebar-menu-icon"></span>
                    <div class="sidebar-menu-link">首页</div>
                </div>
            
                <div class="sidebar-menu-link-wrap">
                    <a class="sidebar-menu-link-dummy" href="/archives"></a>
                    <span class="sidebar-menu-icon"></span>
                    <div class="sidebar-menu-link">归档</div>
                </div>
            
                <div class="sidebar-menu-link-wrap">
                    <a class="sidebar-menu-link-dummy" href="/about"></a>
                    <span class="sidebar-menu-icon"></span>
                    <div class="sidebar-menu-link">关于</div>
                </div>
            
                <div class="sidebar-menu-link-wrap">
                    <a class="sidebar-menu-link-dummy" href="/friend"></a>
                    <span class="sidebar-menu-icon"></span>
                    <div class="sidebar-menu-link">友链</div>
                </div>
            
        </div>
    </div>
    
        
    <div class="widget-wrap wow fadeInRight">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AimGraduate/">AimGraduate</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Essay/">Essay</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/GoAbroad/">GoAbroad</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/internship/">internship</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/internship/spikingjelly/">spikingjelly</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/paper/">paper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/project/">project</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/reading/">reading</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%93%E4%B8%9A%E7%9F%A5%E8%AF%86/">专业知识</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%93%E4%B8%9A%E7%9F%A5%E8%AF%86/Database/">Database</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%93%E4%B8%9A%E7%9F%A5%E8%AF%86/NNDL/">NNDL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%93%E4%B8%9A%E7%9F%A5%E8%AF%86/OS/">OS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%93%E4%B8%9A%E7%9F%A5%E8%AF%86/SE/">SE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%93%E4%B8%9A%E7%9F%A5%E8%AF%86/d2l/">d2l</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%93%E4%B8%9A%E7%9F%A5%E8%AF%86/%E6%99%BA%E8%83%BD%E8%AE%A1%E7%AE%97%E7%B3%BB%E7%BB%9F/">智能计算系统</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%93%E4%B8%9A%E7%9F%A5%E8%AF%86/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E9%A1%B9/">杂项</a></li></ul>
        </div>
    </div>


    
        
    <div class="widget-wrap wow fadeInRight">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/0/" style="font-size: 10px;">0</a> <a href="/tags/1/" style="font-size: 10px;">1</a> <a href="/tags/11-11/" style="font-size: 10px;">11.11</a> <a href="/tags/2/" style="font-size: 10px;">2</a> <a href="/tags/3/" style="font-size: 10px;">3</a> <a href="/tags/3-1/" style="font-size: 10px;">3-1</a> <a href="/tags/AI/" style="font-size: 10px;">AI</a> <a href="/tags/AI-Ethics/" style="font-size: 10px;">AI Ethics</a> <a href="/tags/Advanced-SQL/" style="font-size: 10px;">Advanced SQL</a> <a href="/tags/Advancing-Spiking-Neural-Networks-towards-Deep-Residual-Learning/" style="font-size: 11.43px;">Advancing Spiking Neural Networks towards Deep Residual Learning</a> <a href="/tags/Ai-Ethics/" style="font-size: 10px;">Ai Ethics</a> <a href="/tags/AimGraduate/" style="font-size: 10.71px;">AimGraduate</a> <a href="/tags/An-Overview-of-the-BLITZ-Computer-Hardware/" style="font-size: 10px;">An Overview of the BLITZ Computer Hardware</a> <a href="/tags/An-Overview-of-the-BLITZ-System/" style="font-size: 10px;">An Overview of the BLITZ System</a> <a href="/tags/Anything/" style="font-size: 10px;">Anything</a> <a href="/tags/Artificial-neural-networks/" style="font-size: 10px;">Artificial neural networks</a> <a href="/tags/Attention/" style="font-size: 10px;">Attention</a> <a href="/tags/BasciConception/" style="font-size: 10px;">BasciConception</a> <a href="/tags/Benchmark/" style="font-size: 10px;">Benchmark</a> <a href="/tags/Blitz/" style="font-size: 12.14px;">Blitz</a> <a href="/tags/CAS/" style="font-size: 10px;">CAS</a> <a href="/tags/CAS%E5%AE%9E%E4%B9%A0offer/" style="font-size: 10px;">CAS实习offer</a> <a href="/tags/CMU15-445/" style="font-size: 10px;">CMU15-445</a> <a href="/tags/CV/" style="font-size: 10px;">CV</a> <a href="/tags/Causal-Analysis-Churn/" style="font-size: 13.57px;">Causal Analysis Churn</a> <a href="/tags/Causal-Reasoning/" style="font-size: 10px;">Causal Reasoning</a> <a href="/tags/Container/" style="font-size: 10px;">Container</a> <a href="/tags/Convolutional-SNN-to-Classify-FMNIST/" style="font-size: 10px;">Convolutional SNN to Classify FMNIST</a> <a href="/tags/Cover-Letter/" style="font-size: 10px;">Cover Letter</a> <a href="/tags/DIY/" style="font-size: 10px;">DIY</a> <a href="/tags/Deep-Learning/" style="font-size: 10px;">Deep Learning</a> <a href="/tags/Deep-learning/" style="font-size: 10px;">Deep learning</a> <a href="/tags/DeepFM/" style="font-size: 10px;">DeepFM</a> <a href="/tags/English/" style="font-size: 10.71px;">English</a> <a href="/tags/Ensemble/" style="font-size: 10px;">Ensemble</a> <a href="/tags/Essay/" style="font-size: 19.29px;">Essay</a> <a href="/tags/GEAR-5/" style="font-size: 10px;">GEAR-5</a> <a href="/tags/Git/" style="font-size: 10.71px;">Git</a> <a href="/tags/GitHub/" style="font-size: 10px;">GitHub</a> <a href="/tags/GoAbroad/" style="font-size: 16.43px;">GoAbroad</a> <a href="/tags/Gumayusi/" style="font-size: 10px;">Gumayusi</a> <a href="/tags/HKU/" style="font-size: 10px;">HKU</a> <a href="/tags/IC/" style="font-size: 10px;">IC</a> <a href="/tags/IELTS/" style="font-size: 11.43px;">IELTS</a> <a href="/tags/IntelliJ-IDEA/" style="font-size: 10px;">IntelliJ IDEA</a> <a href="/tags/Intermediate-SQL/" style="font-size: 10px;">Intermediate SQL</a> <a href="/tags/Introduction/" style="font-size: 10px;">Introduction</a> <a href="/tags/Introduction-to-SQL/" style="font-size: 10px;">Introduction to SQL</a> <a href="/tags/Introduction-to-the-Relational-Model/" style="font-size: 10px;">Introduction to the Relational Model</a> <a href="/tags/Jianfei-Chen/" style="font-size: 10px;">Jianfei Chen</a> <a href="/tags/Lab1/" style="font-size: 10px;">Lab1</a> <a href="/tags/Lec01/" style="font-size: 11.43px;">Lec01</a> <a href="/tags/Lec01s/" style="font-size: 10.71px;">Lec01s</a> <a href="/tags/Lime/" style="font-size: 10px;">Lime</a> <a href="/tags/Linux/" style="font-size: 10.71px;">Linux</a> <a href="/tags/M2/" style="font-size: 10.71px;">M2</a> <a href="/tags/MIT6-S081/" style="font-size: 12.86px;">MIT6.S081</a> <a href="/tags/MS-ResNet/" style="font-size: 10px;">MS-ResNet</a> <a href="/tags/Mac/" style="font-size: 10.71px;">Mac</a> <a href="/tags/Missing-Semester/" style="font-size: 10px;">Missing Semester</a> <a href="/tags/Monitor/" style="font-size: 10px;">Monitor</a> <a href="/tags/NNDL/" style="font-size: 11.43px;">NNDL</a> <a href="/tags/NTU/" style="font-size: 10px;">NTU</a> <a href="/tags/Neural-Network/" style="font-size: 10px;">Neural Network</a> <a href="/tags/Neural-Network-from-Shallow-to-Deep/" style="font-size: 10px;">Neural Network from Shallow to Deep</a> <a href="/tags/Neuromorphic-computing/" style="font-size: 10px;">Neuromorphic computing</a> <a href="/tags/Neuron/" style="font-size: 10px;">Neuron</a> <a href="/tags/PyTorch/" style="font-size: 10px;">PyTorch</a> <a href="/tags/Qingyao-Ai/" style="font-size: 10.71px;">Qingyao Ai</a> <a href="/tags/RISC-V/" style="font-size: 10px;">RISC-V</a> <a href="/tags/ReadMemory/" style="font-size: 10px;">ReadMemory</a> <a href="/tags/ResNet/" style="font-size: 10px;">ResNet</a> <a href="/tags/Rethinking-the-performance-comparison-between-SNNS-and-ANNS/" style="font-size: 10px;">Rethinking the performance comparison between SNNS and ANNS</a> <a href="/tags/SE/" style="font-size: 10px;">SE</a> <a href="/tags/SE-3-0/" style="font-size: 10px;">SE-3.0</a> <a href="/tags/SNN/" style="font-size: 11.43px;">SNN</a> <a href="/tags/SNN-vs-RNN/" style="font-size: 10px;">SNN vs RNN</a> <a href="/tags/SPIKEBERT/" style="font-size: 10px;">SPIKEBERT</a> <a href="/tags/STGgameAI/" style="font-size: 10px;">STGgameAI</a> <a href="/tags/Single-Fully-Connected-Layer-SNN-to-Classify-MNIST/" style="font-size: 10px;">Single Fully Connected Layer SNN to Classify MNIST</a> <a href="/tags/Spiking-neural-network/" style="font-size: 10.71px;">Spiking neural network</a> <a href="/tags/Spiking-neural-networks/" style="font-size: 10px;">Spiking neural networks</a> <a href="/tags/SpikingBERT/" style="font-size: 10px;">SpikingBERT</a> <a href="/tags/StarBucks/" style="font-size: 12.14px;">StarBucks</a> <a href="/tags/Surrogate-Gradient-Method/" style="font-size: 10px;">Surrogate Gradient Method</a> <a href="/tags/T1/" style="font-size: 12.86px;">T1</a> <a href="/tags/T1-fighting/" style="font-size: 10.71px;">T1 fighting</a> <a href="/tags/THU/" style="font-size: 10px;">THU</a> <a href="/tags/TUM/" style="font-size: 10px;">TUM</a> <a href="/tags/Tai-Jiang-Mu/" style="font-size: 10px;">Tai-Jiang Mu</a> <a href="/tags/The-Thread-Scheduler-and-Concurrency-Control-Primitives/" style="font-size: 10px;">The Thread Scheduler and Concurrency Control Primitives</a> <a href="/tags/University/" style="font-size: 13.57px;">University</a> <a href="/tags/Yuxiao-Dong/" style="font-size: 10.71px;">Yuxiao Dong</a> <a href="/tags/ai-ethics/" style="font-size: 10px;">ai ethics</a> <a href="/tags/author/" style="font-size: 10px;">author</a> <a href="/tags/bert/" style="font-size: 12.14px;">bert</a> <a href="/tags/bing/" style="font-size: 10px;">bing</a> <a href="/tags/blitz/" style="font-size: 10px;">blitz</a> <a href="/tags/bug/" style="font-size: 10px;">bug</a> <a href="/tags/causal-churn-word/" style="font-size: 10px;">causal churn word</a> <a href="/tags/chapter00/" style="font-size: 10px;">chapter00</a> <a href="/tags/chapter01/" style="font-size: 10.71px;">chapter01</a> <a href="/tags/chapter02/" style="font-size: 10.71px;">chapter02</a> <a href="/tags/chapter03/" style="font-size: 10px;">chapter03</a> <a href="/tags/chapter04/" style="font-size: 10px;">chapter04</a> <a href="/tags/chapter05/" style="font-size: 10px;">chapter05</a> <a href="/tags/chatgpt-prompt/" style="font-size: 10px;">chatgpt prompt</a> <a href="/tags/code/" style="font-size: 11.43px;">code</a> <a href="/tags/coding/" style="font-size: 17.14px;">coding</a> <a href="/tags/cold%F0%9F%98%B7/" style="font-size: 10px;">cold😷</a> <a href="/tags/courseinfo/" style="font-size: 10px;">courseinfo</a> <a href="/tags/d2l/" style="font-size: 10px;">d2l</a> <a href="/tags/dalle3/" style="font-size: 10px;">dalle3</a> <a href="/tags/database/" style="font-size: 14.29px;">database</a> <a href="/tags/debug/" style="font-size: 11.43px;">debug</a> <a href="/tags/deep-neural-network/" style="font-size: 10.71px;">deep neural network</a> <a href="/tags/discussion/" style="font-size: 10px;">discussion</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/dowhy/" style="font-size: 10.71px;">dowhy</a> <a href="/tags/echo/" style="font-size: 10px;">echo</a> <a href="/tags/email/" style="font-size: 10px;">email</a> <a href="/tags/explainer/" style="font-size: 10.71px;">explainer</a> <a href="/tags/fee/" style="font-size: 10px;">fee</a> <a href="/tags/game/" style="font-size: 10px;">game</a> <a href="/tags/gpt/" style="font-size: 10px;">gpt</a> <a href="/tags/gym/" style="font-size: 11.43px;">gym</a> <a href="/tags/hacker/" style="font-size: 10px;">hacker</a> <a href="/tags/handout/" style="font-size: 10px;">handout</a> <a href="/tags/happy/" style="font-size: 10px;">happy</a> <a href="/tags/homework/" style="font-size: 10px;">homework</a> <a href="/tags/imap/" style="font-size: 10px;">imap</a> <a href="/tags/instructor/" style="font-size: 12.14px;">instructor</a> <a href="/tags/intern-00/" style="font-size: 10px;">intern-00</a> <a href="/tags/intern00/" style="font-size: 12.14px;">intern00</a> <a href="/tags/internship/" style="font-size: 17.86px;">internship</a> <a href="/tags/introduction/" style="font-size: 11.43px;">introduction</a> <a href="/tags/kfc/" style="font-size: 10px;">kfc</a> <a href="/tags/knowledge-distillaion/" style="font-size: 10px;">knowledge distillaion</a> <a href="/tags/l1/" style="font-size: 10px;">l1</a> <a href="/tags/l2/" style="font-size: 10px;">l2</a> <a href="/tags/l3/" style="font-size: 10px;">l3</a> <a href="/tags/lab1/" style="font-size: 10px;">lab1</a> <a href="/tags/lab2/" style="font-size: 10.71px;">lab2</a> <a href="/tags/lec01/" style="font-size: 10px;">lec01</a> <a href="/tags/llm/" style="font-size: 10px;">llm</a> <a href="/tags/m/" style="font-size: 10px;">m</a> <a href="/tags/mac/" style="font-size: 10px;">mac</a> <a href="/tags/mlp/" style="font-size: 10px;">mlp</a> <a href="/tags/mnist/" style="font-size: 10px;">mnist</a> <a href="/tags/model-evaluation/" style="font-size: 10px;">model evaluation</a> <a href="/tags/neuromorphic-computing/" style="font-size: 10.71px;">neuromorphic computing</a> <a href="/tags/nndl/" style="font-size: 10.71px;">nndl</a> <a href="/tags/note/" style="font-size: 10px;">note</a> <a href="/tags/one-piece/" style="font-size: 10px;">one piece</a> <a href="/tags/openai/" style="font-size: 10px;">openai</a> <a href="/tags/os/" style="font-size: 15px;">os</a> <a href="/tags/outlook/" style="font-size: 10px;">outlook</a> <a href="/tags/overview/" style="font-size: 10px;">overview</a> <a href="/tags/p1/" style="font-size: 10px;">p1</a> <a href="/tags/p2/" style="font-size: 11.43px;">p2</a> <a href="/tags/paper/" style="font-size: 18.57px;">paper</a> <a href="/tags/photo/" style="font-size: 10px;">photo</a> <a href="/tags/pku/" style="font-size: 10px;">pku</a> <a href="/tags/preparation/" style="font-size: 10px;">preparation</a> <a href="/tags/prml/" style="font-size: 12.14px;">prml</a> <a href="/tags/pytorch/" style="font-size: 10px;">pytorch</a> <a href="/tags/qemu/" style="font-size: 10px;">qemu</a> <a href="/tags/question/" style="font-size: 10px;">question</a> <a href="/tags/reading/" style="font-size: 10px;">reading</a> <a href="/tags/redemption/" style="font-size: 10px;">redemption</a> <a href="/tags/research-vs-coursework/" style="font-size: 10px;">research vs coursework</a> <a href="/tags/rsa/" style="font-size: 10px;">rsa</a> <a href="/tags/se/" style="font-size: 15.71px;">se</a> <a href="/tags/self-attention/" style="font-size: 10px;">self-attention</a> <a href="/tags/shap/" style="font-size: 11.43px;">shap</a> <a href="/tags/shell-vs-terminal/" style="font-size: 10px;">shell vs terminal</a> <a href="/tags/simple/" style="font-size: 10px;">simple</a> <a href="/tags/spike/" style="font-size: 10.71px;">spike</a> <a href="/tags/spikingjelly/" style="font-size: 12.86px;">spikingjelly</a> <a href="/tags/spikngjelly/" style="font-size: 10.71px;">spikngjelly</a> <a href="/tags/starbucks/" style="font-size: 10px;">starbucks</a> <a href="/tags/tensor-vs-ndarray/" style="font-size: 10px;">tensor vs ndarray</a> <a href="/tags/third-place/" style="font-size: 10px;">third place</a> <a href="/tags/thu/" style="font-size: 10px;">thu</a> <a href="/tags/tips/" style="font-size: 10.71px;">tips</a> <a href="/tags/tool/" style="font-size: 15.71px;">tool</a> <a href="/tags/transformer/" style="font-size: 11.43px;">transformer</a> <a href="/tags/uml/" style="font-size: 10px;">uml</a> <a href="/tags/wbg%E8%AF%AD%E9%9F%B3-uzi/" style="font-size: 10px;">wbg语音-uzi</a> <a href="/tags/word/" style="font-size: 10px;">word</a> <a href="/tags/writing/" style="font-size: 10px;">writing</a> <a href="/tags/xv6/" style="font-size: 10px;">xv6</a> <a href="/tags/youth/" style="font-size: 10px;">youth</a> <a href="/tags/zero/" style="font-size: 10px;">zero</a> <a href="/tags/zeus/" style="font-size: 10px;">zeus</a> <a href="/tags/%E4%B8%83%E5%A4%95/" style="font-size: 10px;">七夕</a> <a href="/tags/%E4%B8%93%E4%B8%9A%E7%9F%A5%E8%AF%86/" style="font-size: 20px;">专业知识</a> <a href="/tags/%E4%B8%AD%E4%BB%8B/" style="font-size: 10px;">中介</a> <a href="/tags/%E4%B8%AD%E7%A7%91%E9%99%A2/" style="font-size: 10px;">中科院</a> <a href="/tags/%E5%86%8D%E4%B9%9F%E4%B8%8D%E7%94%A8%E8%A2%AB%E7%BA%A6%E5%AE%9A%E6%9D%9F%E7%BC%9A%E4%BA%86/" style="font-size: 10px;">再也不用被约定束缚了</a> <a href="/tags/%E5%86%8D%E8%A7%81%E7%BB%98%E6%A2%A8/" style="font-size: 10px;">再见绘梨</a> <a href="/tags/%E5%86%99%E4%BD%9C%E5%BF%83%E5%BE%97/" style="font-size: 10px;">写作心得</a> <a href="/tags/%E5%8A%A8%E6%89%8B%E5%AD%A6%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" style="font-size: 10px;">动手学深度学习</a> <a href="/tags/%E5%8D%9A%E4%BA%BA%E4%BC%A0/" style="font-size: 10px;">博人传</a> <a href="/tags/%E5%8F%AA%E8%A6%81%E6%9C%89%E7%9C%9F%E5%BF%83%E5%96%9C%E6%AC%A2%E7%9A%84%E4%B8%9C%E8%A5%BF-%E5%B0%B1%E8%83%BD%E5%8F%91%E5%87%BA%E5%85%89%E6%9D%A5/" style="font-size: 10px;">只要有真心喜欢的东西,就能发出光来</a> <a href="/tags/%E5%93%88%E5%B8%8C%E5%80%BC/" style="font-size: 10px;">哈希值</a> <a href="/tags/%E5%9C%A3%E5%A2%83/" style="font-size: 10px;">圣境</a> <a href="/tags/%E5%A4%A7%E4%B8%89%E4%B8%8A/" style="font-size: 10px;">大三上</a> <a href="/tags/%E5%AE%A1%E7%A8%BF%E6%84%8F%E8%A7%81/" style="font-size: 10.71px;">审稿意见</a> <a href="/tags/%E5%BC%BA%E5%BC%B1com/" style="font-size: 10px;">强弱com</a> <a href="/tags/%E5%BD%A2%E5%8A%BF%E4%B8%8E%E6%94%BF%E7%AD%96/" style="font-size: 10px;">形势与政策</a> <a href="/tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/" style="font-size: 10px;">快捷键</a> <a href="/tags/%E6%80%80%E6%8F%A3%E7%9D%80%E4%B8%80%E5%AE%9A%E5%8F%AF%E4%BB%A5%E5%81%9A%E5%A5%BD%E7%9A%84%E7%A1%AE%E4%BF%A1/" style="font-size: 10px;">怀揣着一定可以做好的确信</a> <a href="/tags/%E6%83%85%E7%BB%AA%E7%9A%84%E7%A7%98%E5%AF%86/" style="font-size: 10px;">情绪的秘密</a> <a href="/tags/%E6%84%9F%E5%86%92/" style="font-size: 10px;">感冒</a> <a href="/tags/%E6%84%9F%E5%86%92%E7%97%8A%E6%84%88/" style="font-size: 10px;">感冒痊愈</a> <a href="/tags/%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84/" style="font-size: 10px;">拓扑结构</a> <a href="/tags/%E6%8F%90%E9%97%AE/" style="font-size: 10px;">提问</a> <a href="/tags/%E6%90%AC%E5%AE%B6/" style="font-size: 10px;">搬家</a> <a href="/tags/%E6%94%BE%E4%B8%8B/" style="font-size: 10px;">放下</a> <a href="/tags/%E6%95%99%E5%B8%88%E8%8A%82/" style="font-size: 10px;">教师节</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C-%E9%A2%84%E5%A4%84%E7%90%86/" style="font-size: 10px;">数据操作+预处理</a> <a href="/tags/%E6%99%BA%E6%85%A7%E6%A0%91/" style="font-size: 10px;">智慧树</a> <a href="/tags/%E6%99%BA%E8%83%BD%E8%AE%A1%E7%AE%97%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">智能计算系统</a> <a href="/tags/%E6%9C%80%E9%95%BF%E7%9A%84%E7%94%B5%E5%BD%B1/" style="font-size: 10.71px;">最长的电影</a> <a href="/tags/%E6%9C%9F%E4%B8%AD%E5%A4%8D%E4%B9%A0/" style="font-size: 10px;">期中复习</a> <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" style="font-size: 10px;">机器学习</a> <a href="/tags/%E6%9D%82%E9%A1%B9/" style="font-size: 10px;">杂项</a> <a href="/tags/%E6%9D%8E%E5%AE%8F%E6%AF%85/" style="font-size: 10px;">李宏毅</a> <a href="/tags/%E6%A6%82%E8%AE%BA/" style="font-size: 10px;">概论</a> <a href="/tags/%E6%AF%9B%E6%A6%82/" style="font-size: 13.57px;">毛概</a> <a href="/tags/%E6%B2%88%E6%9C%88/" style="font-size: 10px;">沈月</a> <a href="/tags/%E6%B2%A1%E9%82%A3%E4%B9%88%E7%AE%80%E5%8D%95/" style="font-size: 10px;">没那么简单</a> <a href="/tags/%E7%81%AB%E9%BE%99%E5%A4%A7%E7%82%AC/" style="font-size: 10px;">火龙大炬</a> <a href="/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 10px;">环境搭建</a> <a href="/tags/%E7%94%A8%E4%BE%8B%E6%A8%A1%E5%9E%8B/" style="font-size: 10px;">用例模型</a> <a href="/tags/%E7%9F%A5%E8%A1%8C%E5%90%88%E4%B8%80/" style="font-size: 10px;">知行合一</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E5%BB%BA%E8%AE%AE%E4%B9%A6/" style="font-size: 10px;">系统开发建议书</a> <a href="/tags/%E8%8E%93/" style="font-size: 10px;">莓</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 10px;">虚拟机</a> <a href="/tags/%E8%A7%84%E5%88%99/" style="font-size: 10px;">规则</a> <a href="/tags/%E8%AE%A1%E7%BD%91/" style="font-size: 10px;">计网</a> <a href="/tags/%E8%AF%BE%E5%A0%82%E8%AE%A8%E8%AE%BA/" style="font-size: 10px;">课堂讨论</a> <a href="/tags/%E8%AF%BE%E7%A8%8B%E8%A1%A8/" style="font-size: 10px;">课程表</a> <a href="/tags/%E8%AF%BE%E8%AE%BE/" style="font-size: 10px;">课设</a> <a href="/tags/%E8%B0%83%E7%A0%94/" style="font-size: 10.71px;">调研</a> <a href="/tags/%E8%BD%AF%E4%BB%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A8%A1%E5%9E%8B/" style="font-size: 10px;">软件生命周期模型</a> <a href="/tags/%E8%BE%93%E5%85%A5%E6%B3%95/" style="font-size: 10px;">输入法</a> <a href="/tags/%E9%99%B6%E7%93%B7/" style="font-size: 10px;">陶瓷</a> <a href="/tags/%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90/" style="font-size: 10px;">需求分析</a> <a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90%E5%BB%BA%E6%A8%A1/" style="font-size: 10px;">面向对象的需求分析建模</a> <a href="/tags/%E9%A2%86%E5%9F%9F%E6%A8%A1%E5%9E%8B/" style="font-size: 10px;">领域模型</a> <a href="/tags/%F0%9F%93%A6/" style="font-size: 10px;">📦</a> <a href="/tags/%F0%9F%9B%80/" style="font-size: 10px;">🛀</a>
        </div>
    </div>


    
        
    <div class="widget-wrap wow fadeInRight">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/11/">十一月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">九月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">八月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">七月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">六月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a></li></ul>
        </div>
    </div>


    
</aside>

                
            </div>
            <footer id="footer" class="wow fadeInUp">
    <div style="width: 100%; overflow: hidden"><div class="footer-line"></div></div>
    <div class="outer">
        <div id="footer-info" class="inner">
            
            <div>
                <span class="icon-copyright"></span>
                2020-2023
                <span class="footer-info-sep"></span>
                野中晴
            </div>
            
                <div>
                    基于&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;
                    Theme.<a href="https://github.com/D-Sketon/hexo-theme-reimu" target="_blank">Reimu</a>
                </div>
            
            
                <div>
                    <span class="icon-brush"></span>
                    374.8k
                    &nbsp;|&nbsp;
                    <span class="icon-coffee"></span>
                    23:41
                </div>
            
            
                <div>
                    <span class="icon-eye"></span>
                    <span id="busuanzi_container_site_pv">总访问量&nbsp;<span id="busuanzi_value_site_pv"></span></span>
                    &nbsp;|&nbsp;
                    <span class="icon-user"></span>
                    <span id="busuanzi_container_site_uv">总访客量&nbsp;<span id="busuanzi_value_site_uv"></span></span>
                </div>
            
        </div>
    </div>
</footer>

        </div>
        <nav id="mobile-nav">
    <div class="sidebar-wrap">
        <div class="sidebar-author">
            <img data-src="/avatar/avatar.jpg" data-sizes="auto" alt="野中晴" class="lazyload">
            <div class="sidebar-author-name">野中晴</div>
            <div class="sidebar-description">Love is selfish.</div>
        </div>
        <div class="sidebar-state">
            <div class="sidebar-state-article">
                <div>文章</div>
                <div class="sidebar-state-number">194</div>
            </div>
            <div class="sidebar-state-category">
                <div>分类</div>
                <div class="sidebar-state-number">18</div>
            </div>
            <div class="sidebar-state-tag">
                <div>标签</div>
                <div class="sidebar-state-number">254</div>
            </div>
        </div>
        <div class="sidebar-social">
            
                <div class=icon-github>
                    <a href=https://github.com/abinzzz itemprop="url" target="_blank"></a>
                </div>
            
        </div>
        <div class="sidebar-menu">
            
                <div class="sidebar-menu-link-wrap">
                    <a class="sidebar-menu-link-dummy" href="/"></a>
                    <span class="sidebar-menu-icon"></span>
                    <div class="sidebar-menu-link">首页</div>
                </div>
            
                <div class="sidebar-menu-link-wrap">
                    <a class="sidebar-menu-link-dummy" href="/archives"></a>
                    <span class="sidebar-menu-icon"></span>
                    <div class="sidebar-menu-link">归档</div>
                </div>
            
                <div class="sidebar-menu-link-wrap">
                    <a class="sidebar-menu-link-dummy" href="/about"></a>
                    <span class="sidebar-menu-icon"></span>
                    <div class="sidebar-menu-link">关于</div>
                </div>
            
                <div class="sidebar-menu-link-wrap">
                    <a class="sidebar-menu-link-dummy" href="/friend"></a>
                    <span class="sidebar-menu-icon"></span>
                    <div class="sidebar-menu-link">友链</div>
                </div>
            
        </div>
    </div>
</nav>

        
<script src="https://unpkg.com/jquery@3.7.0/dist/jquery.min.js"></script>


<script src="https://unpkg.com/lazysizes@5.3.2/lazysizes.min.js"></script>


<script src="https://unpkg.com/clipboard@2.0.11/dist/clipboard.min.js"></script>



    
<script src="https://unpkg.com/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>



    
<script src="https://unpkg.com/busuanzi@2.3.0/bsz.pure.mini.js"></script>






<script src="/js/script.js"></script>
















    </div>
    <div class="site-search">
        <div class="algolia-popup popup">
            <div class="algolia-search">
                <span class="algolia-search-input-icon"></span>
                <div class="algolia-search-input" id="algolia-search-input"></div>
            </div>

            <div class="algolia-results">
                <div id="algolia-stats"></div>
                <div id="algolia-hits"></div>
                <div id="algolia-pagination" class="algolia-pagination"></div>
            </div>

            <span class="popup-btn-close"></span>
        </div>
    </div>
    <!-- hexo injector body_end start -->
<script src="/js/insertHighlight.js"></script>
<!-- hexo injector body_end end --></body>
    </html>

